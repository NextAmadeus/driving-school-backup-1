<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>퍼펙트운전면허 - 예약 관리</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css?v=20241225">
    <style>
        /* 예약 관리 전용 스타일 */
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #1a2a4d;
            border-radius: 12px;
            border: 1px solid #2a4376;
        }
        
        .reservation-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin: 0;
        }
        
        .reservation-subtitle {
            color: #9ca3af;
            font-size: 14px;
            margin: 4px 0 0 0;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin: 0;
        }
        
        .content {
            display: block !important;
        }
        
        .calendar-container {
            display: grid;
            grid-template-columns: 1fr;
            width: 100%;
            overflow-x: auto;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .legend-color.course { background: #61fe3e; }
        .legend-color.time { background: #643efe; }
        .legend-color.none { background: #fef13e; }
        .legend-color.absent { background: #ef4444; }
        .legend-color.unlimited { background: #10b981; }
        .legend-color.custom { background: #eebedf; }
        
        
        .calendar-container {
            background: #0f1a30;
            border: 1px solid #2a4376;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .calendar-wrapper {
            overflow-x: auto; /* 가로 스크롤 복원 */
            overflow-y: auto;
            max-height: 800px; /* 최대 높이 600px → 800px로 확장 */
            scrollbar-width: thin;
            -ms-overflow-style: auto;
        }
        
        .calendar-wrapper::-webkit-scrollbar {
            height: 8px; /* 가로 스크롤바 복원 */
            width: 8px; /* 세로 스크롤바 표시 */
        }
        .calendar-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .calendar-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .calendar-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 현재 시간 표시선 */
        .current-time-line {
            position: absolute;
            left: 520px; /* 시간 컬럼(120px) + 월요일 컬럼(400px) = 520px */
            width: 400px; /* 화요일 컬럼 너비만큼 제한 */
            height: 2px;
            background: #ef4444;
            z-index: 1000; /* 높은 z-index로 다른 요소들 위에 표시 */
            pointer-events: none;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5); /* 선명한 표시를 위한 그림자 */
        }
        
        .current-time-indicator {
            position: absolute;
            left: 115px; /* 시간 컬럼 내부 */
            width: 0;
            height: 0;
            border-left: 6px solid #ef4444;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            z-index: 1001; /* 선보다 더 높은 z-index */
            pointer-events: none;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: 120px repeat(7, 400px); /* 시간 컬럼 120px, 각 요일 컬럼 400px로 2배 확장 */
            background: #1a2a4d;
            border-bottom: 1px solid #2a4376;
            overflow: visible; /* 스크롤 제거 */
            position: relative;
            z-index: 100; /* 예약 블록보다 위에 표시 */
        }
        
        .calendar-header > div {
            padding: 16px 12px;
            text-align: center;
            font-weight: 600;
            color: #e5e7eb;
            border-right: 1px solid #2a4376;
            background: #1a2a4d !important;
            position: relative;
            z-index: 1000;
        }
        
        .calendar-header > div:last-child {
            border-right: none;
        }
        
        .calendar-body {
            display: grid;
            grid-template-columns: 120px repeat(7, 400px); /* 시간 컬럼 120px, 각 요일 컬럼 400px로 2배 확장 */
            min-height: 600px; /* 최소 높이 설정 */
        }
        
        .time-slot {
            padding: 16px 12px;
            text-align: center;
            font-weight: 500;
            color: #9ca3af;
            border-right: 1px solid #2a4376;
            border-bottom: 1px solid #2a4376;
            background: #0f1a30;
            position: sticky;
            left: 0;
            z-index: 1002; /* 빨간색 선(1000)보다 높게 설정 */
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-column {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            background: #2a4376;
        }
        
        .reservation-slot {
            height: 60px;
            background: #1a2a4d;
            border-right: 1px solid #2a4376;
            border-bottom: 1px solid #2a4376;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
            min-height: 60px;
        }
        
        .reservation-slot:hover {
            background: #2a4376;
        }
        
        .reservation-slot.selected {
            background: #3b82f6;
        }
        
        /* 오늘 날짜 셀 스타일 - 더 강력한 선택자 */
        body .reservation-slot.today {
            background: #ffffff !important;
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 0 0 2px #3b82f6 !important;
        }
        
        body .reservation-slot.today:hover {
            background: #f0f9ff !important;
        }
        
        /* 오늘 날짜 셀 강제 적용 - 수요일(10/1) */
        .reservation-slot[data-day="3"] {
            background: #1a2a4d !important;
        }
        
        .reservation-slot[data-day="3"]:hover {
            background: #2a4376 !important;
        }
        
        /* 추가 강제 적용 */
        body .calendar-body .day-column[data-day="3"] .reservation-slot {
            background: #1a2a4d !important;
        }
        
        .reservation-block {
            position: absolute !important;
            left: 2px !important;
            right: 2px !important;
            top: 0 !important;
            width: calc(100% - 4px) !important;
            background: #3b82f6 !important;
            border-radius: 4px !important;
            color: white !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10 !important; /* 헤더보다 낮게 설정 */
            cursor: pointer !important;
            padding: 2px 4px !important;
            min-height: 24px !important;
            box-sizing: border-box !important;
            transform: translateZ(0) !important; /* GPU 가속으로 렌더링 개선 */
        }
        
        .reservation-block.course { background: #61fe3e !important; }
        .reservation-block.time { background: #643efe !important; }
        .reservation-block.none { background: #fef13e !important; color: #000000 !important; } /* 비회원 - 노란색 배경, 검은색 글씨 */
        .reservation-block.absent { background: #ef4444 !important; }
        .reservation-block.unlimited { background: #10b981 !important; } /* 녹색 - 무제한 */
        .reservation-block.custom { background: #eebedf !important; } /* 기본 색상 */
        
        .reservation-temp {
            position: absolute;
            left: 2px;
            right: 2px;
            background: rgba(59, 130, 246, 0.5);
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            padding: 2px 4px;
            min-height: 24px;
        }
        
        .time-indicator {
            position: fixed;
            background: #1a2a4d;
            color: #e5e7eb;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            pointer-events: none;
            border: 1px solid #3b82f6;
        }
        
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        
        .modal-content {
            background: #1a2a4d;
            border: 1px solid #2a4376;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #e5e7eb;
            margin: 0 0 8px 0;
        }
        
        .modal-subtitle {
            color: #9ca3af;
            font-size: 14px;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            color: #e5e7eb;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            background: #0f1a30;
            border: 1px solid #2a4376;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .time-group {
            display: flex;
            gap: 8px;
        }
        
        .time-group select {
            flex: 1;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        /* 버튼 컨테이너 마진 강제 적용 */
        #normalModeButtons,
        #editModeButtons {
            margin: 0 20px !important;
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">
                <div class="brand__name">퍼펙트운전면허</div>
                <div class="brand__role">응암역점</div>
            </div>
            <nav class="nav">
                <a class="nav__item" href="index.html">회원 현황</a>
                <a class="nav__item active" href="reservations.html">예약 현황</a>
            </nav>
        </aside>

        <main class="main">
            <header class="topbar">
                <div class="topbar__title">예약 관리</div>
                <div class="topbar__spacer"></div>
                <div class="user">
                    <button class="btn btn--ghost" onclick="logout()" style="font-size: 12px;">로그아웃</button>
                </div>
            </header>

            <section class="content">
                <div class="legend" style="margin: 0 0 30px 0; width: 1819px; height: 100px; padding: 8px 0;">
                    <div class="legend-item">
                        <div class="legend-color course"></div>
                        <span>무제한</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color time"></div>
                        <span>시간형</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color none"></div>
                        <span>상품없음(비회원)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color absent"></div>
                        <span>결석처리</span>
                    </div>
                </div>
                <!-- 주간 네비게이션 -->
                <div class="week-navigation" style="display: flex; justify-content: flex-start; align-items: center; gap: 12px; margin: 0 0 30px 0; height: 50px; padding: 8px 0;">
                    <button id="prevWeekBtn" class="nav-btn" style="background: #3b82f6; border: none; border-radius: 8px; padding: 12px 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all 0.2s; color: white;" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.3)'">
                        <span style="font-size: 18px; font-weight: bold;">‹</span>
                    </button>
                    <button id="todayBtn" class="nav-btn" style="background: #1a2a4d; border: none; border-radius: 8px; padding: 12px 20px; cursor: pointer; box-shadow: 0 2px 4px rgba(26, 42, 77, 0.3); transition: all 0.2s; color: white; font-weight: 500;" onmouseover="this.style.background='#0f1a30'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(26, 42, 77, 0.4)'" onmouseout="this.style.background='#1a2a4d'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(26, 42, 77, 0.3)'">
                        오늘
                    </button>
                    <button id="nextWeekBtn" class="nav-btn" style="background: #3b82f6; border: none; border-radius: 8px; padding: 12px 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all 0.2s; color: white;" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.3)'">
                        <span style="font-size: 18px; font-weight: bold;">›</span>
                    </button>
                </div>


                <div class="calendar-container">
                    <div class="calendar-wrapper">
                        <div class="calendar-header">
                            <div>시간</div>
                            <div data-day="1" id="day1">월</div>
                            <div data-day="2" id="day2">화</div>
                            <div data-day="3" id="day3">수</div>
                            <div data-day="4" id="day4">목</div>
                            <div data-day="5" id="day5">금</div>
                            <div data-day="6" id="day6">토</div>
                            <div data-day="7" id="day7">일</div>
                        </div>
                        <div class="calendar-body" id="calendarBody">
                            <!-- 동적으로 생성됨 -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>


    <!-- 완전히 새로운 예약 모달 -->
    <div id="reservationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 45px; border-radius: 15px; max-width: 750px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 45px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #333; font-size: 36px;">새 일정</h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">일정 유형</label>
                <div style="display: flex; gap: 30px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        <input type="radio" name="scheduleType" value="reservation" checked style="transform: scale(1.2);">
                        <span style="color: #333; font-weight: 500;">예약</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        <input type="radio" name="scheduleType" value="quick" style="transform: scale(1.2);">
                        <span style="color: #333; font-weight: 500;">바로가입(비회원)</span>
                    </label>
                </div>
            </div>
            
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">예약일</label>
                <input type="date" id="reservationDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
            </div>
            
            <div style="display: flex; gap: 22px; margin-bottom: 22px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">시작 시간</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="startHour" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="07">07시</option>
                            <option value="08">08시</option>
                            <option value="09">09시</option>
                            <option value="10">10시</option>
                            <option value="11">11시</option>
                            <option value="12">12시</option>
                            <option value="13">13시</option>
                            <option value="14">14시</option>
                            <option value="15">15시</option>
                            <option value="16">16시</option>
                            <option value="17">17시</option>
                            <option value="18">18시</option>
                            <option value="19">19시</option>
                            <option value="20">20시</option>
                            <option value="21">21시</option>
                            <option value="22">22시</option>
                            <option value="23">23시</option>
                            <option value="24">24시</option>
                        </select>
                        <select id="startMinute" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="00">00분</option>
                            <option value="30">30분</option>
                        </select>
                    </div>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">종료 시간</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="endHour" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="07">07시</option>
                            <option value="08">08시</option>
                            <option value="09">09시</option>
                            <option value="10">10시</option>
                            <option value="11">11시</option>
                            <option value="12">12시</option>
                            <option value="13">13시</option>
                            <option value="14">14시</option>
                            <option value="15">15시</option>
                            <option value="16">16시</option>
                            <option value="17">17시</option>
                            <option value="18">18시</option>
                            <option value="19">19시</option>
                            <option value="20">20시</option>
                            <option value="21">21시</option>
                            <option value="22">22시</option>
                            <option value="23">23시</option>
                            <option value="24">24시</option>
                        </select>
                        <select id="endMinute" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="00">00분</option>
                            <option value="30">30분</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">기기 선택</label>
                <select id="deviceSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                    <option value="">기기를 선택해주세요.</option>
                    <option value="device1">기기 1</option>
                    <option value="device2">기기 2</option>
                    <option value="device3">기기 3</option>
                    <option value="device4">기기 4</option>
                </select>
            </div>
            
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">회원 유형</label>
                <div style="display: flex; gap: 30px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        <input type="radio" name="memberType" value="existing" checked style="transform: scale(1.2);">
                        <span style="color: #333; font-weight: 500;">기존회원</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        <input type="radio" name="memberType" value="quick" style="transform: scale(1.2);">
                        <span style="color: #333; font-weight: 500;">바로가입(비회원)</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 22px; margin-bottom: 22px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">회원이름</label>
                    <div style="position: relative;">
                        <input type="text" id="memberSearchInput" placeholder="회원 이름을 검색하세요..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        <div id="memberDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                            <!-- 검색 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>
                    <input type="hidden" id="selectedMemberId" value="">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">연락처</label>
                    <input type="text" id="contactInput" placeholder="연락처를 입력해주세요." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                </div>
            </div>
            
            
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">상품</label>
                <input type="text" id="productInput" placeholder="상품을 입력하세요" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
            </div>
            
            <!-- 시험 일정 섹션 -->
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 12px; font-weight: bold; color: #333; font-size: 16px;">시험 일정</label>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px; color: #666; font-size: 14px;">기능 시험</label>
                        <input type="date" id="functionTestDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background: #f8f9fa; color: #6c757d;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px; color: #666; font-size: 14px;">주행 시험</label>
                        <input type="date" id="roadTestDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background: #f8f9fa; color: #6c757d;">
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 22px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">예약관련 메모</label>
                <textarea id="reservationMemo" rows="3" placeholder="예약 관련 메모를 입력해주세요." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-size: 16px;"></textarea>
            </div>
            
            <!-- 교육 및 메모사항 섹션 -->
            <div style="margin-bottom: 22px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #1f2937; font-size: 16px; margin: 0;">교육 및 메모사항</label>
                    <button type="button" id="addEducationMemoBtn" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); transition: all 0.2s;" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 2px rgba(0, 0, 0, 0.1)'">+</button>
                </div>
                <div id="educationMemosContainer" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;">
                    <!-- 교육 메모 항목들이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
            
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding: 22px 20px 0 20px; overflow: hidden;">
                <!-- 수정 모드 버튼들 (숨김) -->
                <div id="editModeButtons" style="display: none; float: right;">
                    <button id="deleteReservationBtn" style="display: inline-block; margin-right: 12px; padding: 15px 30px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">예약 삭제</button>
                    <button id="markAbsentBtn" style="display: inline-block; margin-right: 12px; padding: 15px 30px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">결석</button>
                    <button id="updateReservationBtn" style="display: inline-block; padding: 15px 30px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">수정</button>
                </div>
                
                <!-- 일반 모드 버튼들 -->
                <div id="normalModeButtons" style="float: right;">
                    <button onclick="closeModal()" style="display: inline-block; margin-right: 12px; padding: 15px 30px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">취소</button>
                    <button onclick="saveReservation('immediate')" style="display: inline-block; margin-right: 12px; padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">바로 예약</button>
                    <button onclick="saveReservation('continue')" style="display: inline-block; padding: 15px 30px; background: #ffc107; color: #212529; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">계속 예약</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // 새로운 예약 시스템 - 깔끔하게 처음부터
        console.log('예약 시스템 초기화');
        
        // 계속 예약을 위한 마지막 회원 정보 저장
        let lastReservationMember = null;
        
        // 로그인 상태 확인
        window.addEventListener('load', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userRole = localStorage.getItem('userRole');
            
            if (isLoggedIn !== 'true' || userRole !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
            
            // 모달이 자동으로 열리지 않도록 확실히 숨김
            const modal = document.getElementById('reservationModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('모달 초기 상태: 숨김');
            }
            
            // 캘린더 초기화
            initializeCalendar();
            
            // 회원 목록 로드
            loadMembers();
        });

        // 로그아웃 기능
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        // 헤더 영역의 잘못된 예약 블록 정리 함수
        function cleanupHeaderBlocks() {
            // 모든 예약 블록 제거 (잘못된 위치에 있는 것들 포함)
            const allBlocks = document.querySelectorAll('.reservation-block');
            if (allBlocks.length > 0) {
                console.log('모든 예약 블록 제거:', allBlocks.length + '개');
                allBlocks.forEach(block => {
                    console.log('제거할 블록:', block);
                    block.remove();
                });
            }
            
            // 헤더 영역의 예약 블록도 제거
            const header = document.querySelector('.calendar-header');
            if (header) {
                const headerBlocks = header.querySelectorAll('.reservation-block');
                if (headerBlocks.length > 0) {
                    console.log('헤더 영역의 잘못된 예약 블록 제거:', headerBlocks.length + '개');
                    headerBlocks.forEach(block => {
                        block.remove();
                    });
                }
            }
        }

        // 현재 표시 중인 주를 추적하는 변수
        let currentWeekStart = null;

        // 현재 주의 날짜 배열을 반환하는 함수
        function getCurrentWeek() {
            if (!currentWeekStart) {
                // currentWeekStart가 없으면 오늘 기준으로 주간 날짜 계산
                const today = new Date();
                const currentDay = today.getDay(); // 0(일요일) ~ 6(토요일)
                const monday = new Date(today);
                monday.setDate(today.getDate() - currentDay + 1);
                
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    weekDates.push(date);
                }
                return weekDates;
            } else {
                // currentWeekStart가 있으면 이를 기준으로 주간 날짜 계산
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + i);
                    weekDates.push(date);
                }
                console.log('📅 getCurrentWeek (currentWeekStart 기준):', {
                    currentWeekStart: currentWeekStart.toISOString().split('T')[0],
                    weekDates: weekDates.map(d => d.toISOString().split('T')[0])
                });
                return weekDates;
            }
        }

        // 현재 주의 날짜를 계산하고 업데이트하는 함수
        function updateWeekDates(weekStart = null) {
            let monday;
            
            if (weekStart) {
                // 특정 주의 월요일이 주어졌을 때
                monday = new Date(weekStart);
            } else {
                // 현재 주의 월요일 계산
                const today = new Date();
                const currentDay = today.getDay(); // 0=일요일, 1=월요일, ..., 6=토요일
                monday = new Date(today);
                monday.setDate(today.getDate() - currentDay + 1);
            }
            
            // 현재 주 시작일 저장
            currentWeekStart = new Date(monday);
            
            // 7일간의 날짜 배열 생성
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                weekDates.push(date);
            }
            
            // 요일 이름과 날짜 업데이트
            const dayNames = ['월', '화', '수', '목', '금', '토', '일'];
            weekDates.forEach((date, index) => {
                const dayElement = document.getElementById(`day${index + 1}`);
                if (dayElement) {
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    dayElement.textContent = `${dayNames[index]} ${month}/${day}`;
                }
            });
            
            // 예약 날짜 입력 필드도 업데이트 (오늘 날짜로)
            const reservationDateInput = document.getElementById('reservationDate');
            if (reservationDateInput) {
                const today = new Date();
                reservationDateInput.value = today.toISOString().split('T')[0];
            }
            
            return weekDates;
        }

        // 이전 주로 이동
        async function goToPreviousWeek() {
            if (currentWeekStart) {
                const prevWeek = new Date(currentWeekStart);
                prevWeek.setDate(prevWeek.getDate() - 7);
                
                // 1. 캘린더 헤더 업데이트
                updateWeekDates(prevWeek);
                
                // 2. 완전히 새로고침 방식으로 변경
                console.log('🔄 이전주로 이동: 완전 새로고침');
                
                // 3. 이전주로 이동 시 빨간색 선과 화살표 즉시 숨김
                const timeLine = document.querySelector('.current-time-line');
                const timeIndicator = document.querySelector('.current-time-indicator');
                if (timeLine) timeLine.style.display = 'none';
                if (timeIndicator) timeIndicator.style.display = 'none';
                
                // 캘린더 전체를 다시 생성
                await clearAndReloadCalendar();
                
                // 해당 주의 예약 로드
                try {
                    const reservations = await loadReservationsFromServer();
                    console.log('이전주 예약 수:', reservations.length);
                    
                    if (reservations && reservations.length > 0) {
                        for (let index = 0; index < reservations.length; index++) {
                            const reservation = reservations[index];
                            
                            let targetDay = reservation.targetDay || 1;
                            let targetSeat = reservation.targetSeat || 1;
                            
                            if (targetDay < 1 || targetDay > 7) {
                                targetDay = 1;
                            }
                            
                            createReservationBlock(
                                reservation.memberName,
                                reservation.memberId,
                                reservation.memberType,
                                reservation.scheduleType,
                                reservation.startHour,
                                reservation.startMinute,
                                reservation.endHour,
                                reservation.endMinute,
                                reservation.reservationMemo,
                                reservation.educationMemos,
                                reservation.functionTestDate,
                                reservation.roadTestDate,
                                reservation.id,
                                targetDay,
                                targetSeat,
                                reservation.productName,
                                reservation.productHours,
                                reservation.contactPhone
                            );
                        }
                    }
                } catch (error) {
                    console.error('예약 로드 오류:', error);
                }
                
                console.log('✅ 이전주로 이동 완료');
            }
        }

        // 다음 주로 이동
        async function goToNextWeek() {
            if (currentWeekStart) {
                const nextWeek = new Date(currentWeekStart);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                // 1. 캘린더 헤더 업데이트
                updateWeekDates(nextWeek);
                
                // 2. 완전히 새로고침 방식으로 변경
                console.log('🔄 다음주로 이동: 완전 새로고침');
                
                // 3. 다음주로 이동 시 빨간색 선과 화살표 즉시 숨김
                const timeLine = document.querySelector('.current-time-line');
                const timeIndicator = document.querySelector('.current-time-indicator');
                if (timeLine) timeLine.style.display = 'none';
                if (timeIndicator) timeIndicator.style.display = 'none';
                
                // 캘린더 전체를 다시 생성
                await clearAndReloadCalendar();
                
                // 해당 주의 예약 로드
                try {
                    const reservations = await loadReservationsFromServer();
                    console.log('다음주 예약 수:', reservations.length);
                    
                    if (reservations && reservations.length > 0) {
                        for (let index = 0; index < reservations.length; index++) {
                            const reservation = reservations[index];
                            
                            let targetDay = reservation.targetDay || 1;
                            let targetSeat = reservation.targetSeat || 1;
                            
                            if (targetDay < 1 || targetDay > 7) {
                                targetDay = 1;
                            }
                            
                            createReservationBlock(
                                reservation.memberName,
                                reservation.memberId,
                                reservation.memberType,
                                reservation.scheduleType,
                                reservation.startHour,
                                reservation.startMinute,
                                reservation.endHour,
                                reservation.endMinute,
                                reservation.reservationMemo,
                                reservation.educationMemos,
                                reservation.functionTestDate,
                                reservation.roadTestDate,
                                reservation.id,
                                targetDay,
                                targetSeat,
                                reservation.productName,
                                reservation.productHours,
                                reservation.contactPhone
                            );
                        }
                    }
                } catch (error) {
                    console.error('예약 로드 오류:', error);
                }
                
                console.log('✅ 다음주로 이동 완료');
            }
        }

        // 캘린더 전체를 완전히 지우고 다시 로드하는 함수
        async function clearAndReloadCalendar() {
            console.log('🔄 주간 이동: 캘린더 완전 재생성');
            
            // 1. 캘린더 바디 완전히 초기화
            const calendarBody = document.getElementById('calendarBody');
            if (calendarBody) {
                calendarBody.innerHTML = '';
            }
            
            // 2. 캘린더 다시 생성
            initializeCalendar();
            
            // 3. 잠시 대기
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log('✅ 캘린더 재생성 완료');
        }
        
        

        // 오늘 주로 이동
        async function goToToday() {
            console.log('🔄 오늘로 이동: 완전 새로고침');
            
            // 1. 현재 주로 설정
            updateWeekDates(); // 현재 주로 이동
            
            // 2. 오늘로 이동 시 빨간색 선과 화살표 다시 표시
            setTimeout(() => {
                updateCurrentTimeLine();
            }, 100);
            
            // 3. 캘린더 전체를 다시 생성
            await clearAndReloadCalendar();
            
            // 3. 현재 주의 예약 로드
            try {
                const reservations = await loadReservationsFromServer();
                console.log('오늘 주 예약 수:', reservations.length);
                
                if (reservations && reservations.length > 0) {
                    for (let index = 0; index < reservations.length; index++) {
                        const reservation = reservations[index];
                        
                        let targetDay = reservation.targetDay || 1;
                        let targetSeat = reservation.targetSeat || 1;
                        
                        if (targetDay < 1 || targetDay > 7) {
                            targetDay = 1;
                        }
                        
                        createReservationBlock(
                            reservation.memberName,
                            reservation.memberId,
                            reservation.memberType,
                            reservation.scheduleType,
                            reservation.startHour,
                            reservation.startMinute,
                            reservation.endHour,
                            reservation.endMinute,
                            reservation.reservationMemo,
                            reservation.educationMemos,
                            reservation.functionTestDate,
                            reservation.roadTestDate,
                            reservation.id,
                            targetDay,
                            targetSeat,
                            reservation.productName,
                            reservation.productHours,
                            reservation.contactPhone
                        );
                    }
                }
            } catch (error) {
                console.error('예약 로드 오류:', error);
            }
            
            console.log('✅ 오늘로 이동 완료');
        }

        // 현재 시간 표시선 업데이트
        function updateCurrentTimeLine(checkDeduction = true) {
            console.log('🕐 updateCurrentTimeLine 호출됨, checkDeduction:', checkDeduction);
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // 현재 주가 오늘의 주인지 확인
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - currentDay + 1);
            
            // 날짜 비교를 위해 시간을 0으로 설정
            monday.setHours(0, 0, 0, 0);
            const currentWeekStartNormalized = new Date(currentWeekStart);
            if (currentWeekStartNormalized) {
                currentWeekStartNormalized.setHours(0, 0, 0, 0);
            }
            
            // 현재 표시 중인 주와 오늘의 주 비교
            const isCurrentWeek = currentWeekStart && 
                currentWeekStartNormalized.getTime() === monday.getTime();
            
            console.log('현재 주인가?', isCurrentWeek);
            console.log('표시 중인 주:', currentWeekStart);
            console.log('오늘의 주:', monday);
            console.log('정규화된 표시 주:', currentWeekStartNormalized);
            console.log('정규화된 오늘 주:', monday);
            
            // 현재 주가 아니면 빨간색 선 숨김 및 차감 로직 완전 중단
            if (!isCurrentWeek) {
                const timeLine = document.querySelector('.current-time-line');
                const timeIndicator = document.querySelector('.current-time-indicator');
                if (timeLine) timeLine.style.display = 'none';
                if (timeIndicator) timeIndicator.style.display = 'none';
                console.log('🚫 현재 주가 아님 - 차감 로직 중단');
                return;
            }
            
            // 현재 시간을 분 단위로 변환 (30분 앞으로 이동, 화살표 높이 보정을 위해 4분 뒤로)
            const currentTimeInMinutes = currentHour * 60 + currentMinute + 30;
            
            // 디버깅용 로그
            console.log('현재 시간:', currentHour + ':' + currentMinute);
            console.log('계산된 시간 (분):', currentTimeInMinutes);
            console.log('계산된 시간 (시:분):', Math.floor(currentTimeInMinutes / 60) + ':' + (currentTimeInMinutes % 60));
            
            // 캘린더 시작 시간 (9:00 = 540분)
            const calendarStartMinutes = 9 * 60; // 540분
            
            // 실제 슬롯 높이 측정
            const timeSlots = document.querySelectorAll('.calendar-body > div');
            let slotHeight = 40; // 기본값
            
            if (timeSlots.length > 0) {
                // 첫 번째 시간 슬롯의 실제 높이 측정
                const firstSlot = timeSlots[0];
                const slotRect = firstSlot.getBoundingClientRect();
                slotHeight = slotRect.height;
                console.log('실제 슬롯 높이:', slotHeight + 'px');
            }
            
            // 현재 시간이 캘린더 범위 내에 있는지 확인
            if (currentTimeInMinutes >= calendarStartMinutes) {
                // 현재 시간까지의 분 수
                const minutesFromStart = currentTimeInMinutes - calendarStartMinutes;
                
                // 픽셀 위치 계산 (30분 단위로 정렬)
                // 9:00-9:30=0, 9:30-10:00=1, 10:00-10:30=2, ...
                const slotIndex = Math.floor(minutesFromStart / 30);
                const slotProgress = (minutesFromStart % 30) / 30; // 0-1 사이의 값
                
                // 디버깅: 슬롯 인덱스 확인
                console.log('슬롯 인덱스 해석:', {
                    minutesFromStart,
                    slotIndex,
                    slotProgress,
                    expectedSlot: `${9 + Math.floor(minutesFromStart / 60)}:${(minutesFromStart % 60).toString().padStart(2, '0')}`
                });
                
                // 정확한 픽셀 위치 (캘린더 내부 기준)
                const calendarTopPosition = (slotIndex + slotProgress) * slotHeight;
                
                // 디버깅 로그 추가
                console.log('minutesFromStart:', minutesFromStart);
                console.log('slotIndex:', slotIndex);
                console.log('slotProgress:', slotProgress);
                console.log('slotHeight:', slotHeight);
                console.log('calendarTopPosition:', calendarTopPosition);
                
                // 캘린더 스크롤 위치 가져오기
                const calendarWrapper = document.querySelector('.calendar-wrapper');
                const scrollTop = calendarWrapper ? calendarWrapper.scrollTop : 0;
                const scrollLeft = calendarWrapper ? calendarWrapper.scrollLeft : 0;
                
                // 현재 시간 표시선 생성 또는 업데이트
                let timeLine = document.querySelector('.current-time-line');
                let timeIndicator = document.querySelector('.current-time-indicator');
                
                if (!timeLine) {
                    timeLine = document.createElement('div');
                    timeLine.className = 'current-time-line';
                    document.querySelector('.calendar-container').appendChild(timeLine);
                }
                
                if (!timeIndicator) {
                    timeIndicator = document.createElement('div');
                    timeIndicator.className = 'current-time-indicator';
                    document.querySelector('.calendar-container').appendChild(timeIndicator);
                }
                
                // 스크롤 위치를 고려한 실제 위치 계산
                const actualTopPosition = calendarTopPosition - scrollTop;
                
                // 오늘 요일에 맞춰서 화살표와 선 위치 계산
                const today = new Date();
                const todayDay = today.getDay(); // 0=일요일, 1=월요일, ..., 6=토요일
                const dayOffset = todayDay === 0 ? 6 : todayDay - 1; // 월요일부터 시작하도록 조정
                const dayWidth = 265; // 각 요일 셀의 너비 (절반 정도 왼쪽으로)
                const dayStartPosition = 520; // 시간 셀 너비
                
                // 화살표와 선을 오늘 요일 셀에 함께 위치 (4px 오른쪽으로 이동)
                const arrowLeftPosition = dayStartPosition + (dayOffset * dayWidth) - scrollLeft + 4;
                
                timeIndicator.style.top = `${actualTopPosition - 2}px`; // 화살표와 선이 겹침
                timeIndicator.style.left = `${arrowLeftPosition}px`; // 오늘 요일 셀
                
                // 시간선도 화살표와 같은 위치로 이동
                timeLine.style.top = `${actualTopPosition}px`;
                timeLine.style.left = `${arrowLeftPosition}px`; // 화살표와 같은 위치
                
                // 표시
                timeLine.style.display = 'block';
                timeIndicator.style.display = 'block';
                
                // 시간 차감 로직 제거 - 예약 저장 시에만 차감
            } else {
                // 현재 시간이 캘린더 범위 밖이면 숨김
                const timeLine = document.querySelector('.current-time-line');
                const timeIndicator = document.querySelector('.current-time-indicator');
                if (timeLine) timeLine.style.display = 'none';
                if (timeIndicator) timeIndicator.style.display = 'none';
            }
        }

        // 간단한 시간 차감 함수 - 데이터베이스에서 예약 불러와서 현재 시간과 비교
        function checkAndDeductReservationTime() {
            console.log('🔍 간단한 시간 차감 시작');
            
            // 데이터베이스에서 오늘의 예약 불러오기
            fetch('api/get_today_reservations.php')
            .then(response => response.json())
            .then(result => {
                if (result.success && result.reservations) {
                    console.log('📅 오늘의 예약 불러옴:', result.reservations.length, '개');
                    
                    const now = new Date();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // 오늘 00:00:00
                    
                    const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
                    
                    result.reservations.forEach(reservation => {
                        // 예약 날짜가 오늘인지 확인
                        const reservationDate = new Date(reservation.reservation_date);
                        reservationDate.setHours(0, 0, 0, 0); // 예약일 00:00:00
                        const isToday = (reservationDate.getTime() === today.getTime());
                        
                        const endTimeInMinutes = parseInt(reservation.end_hour) * 60 + parseInt(reservation.end_minute);
                        
                        console.log(`예약 차감 체크: ${reservation.member_name}, 예약일=${reservation.reservation_date}, 오늘예약=${isToday}, 현재시간=${currentTimeInMinutes}, 종료시간=${endTimeInMinutes}`);
                        
                        // 오늘 예약이고 현재 시간이 예약 종료 시간을 지났으면 차감
                        if (isToday && currentTimeInMinutes >= endTimeInMinutes) {
                            console.log(`💰 ${reservation.member_name} 회원 예약 시간 지남 - 차감 시작`);
                            
                            // 예약 시간 계산 (30분 단위)
                            const startTimeInMinutes = parseInt(reservation.start_hour) * 60 + parseInt(reservation.start_minute);
                            const totalMinutes = endTimeInMinutes - startTimeInMinutes;
                            const blocks = Math.ceil(totalMinutes / 30);
                            const hoursToDeduct = blocks * 0.5;
                            
                            // 차감 API 호출 (reservation_hours_log에 기록 저장)
                            fetch('api/deduct_reservation_hours.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    reservationId: reservation.id,
                                    memberId: reservation.member_id,
                                    hoursToDeduct: hoursToDeduct
                                })
                            }).then(response => response.json())
                            .then(deductResult => {
                                if (deductResult.success) {
                                    console.log(`✅ ${reservation.member_name} 차감 성공: ${hoursToDeduct}시간`);
                                } else {
                                    console.error(`❌ ${reservation.member_name} 차감 실패:`, deductResult.message);
                                }
                            }).catch(error => {
                                console.error(`💥 ${reservation.member_name} 차감 오류:`, error);
                            });
                        }
                    });
                }
            })
            .catch(error => {
                console.error('❌ 예약 불러오기 실패:', error);
            });
        }
        
        // 회원의 잔여시간을 실시간으로 업데이트하는 함수
        function updateMemberRemainingTime(memberId, newUsedHours) {
            // 회원 목록에서 해당 회원 찾기
            if (typeof allMembers !== 'undefined' && allMembers) {
                const member = allMembers.find(m => m.id == memberId);
                if (member) {
                    // used_hours 업데이트
                    member.used_hours = newUsedHours;
                    
                    // 잔여시간 계산 및 표시 업데이트
                    const remainingHours = member.product_hours - newUsedHours;
                    const remainingDays = Math.ceil(remainingHours / (member.product_hours / 365)); // 대략적인 계산
                    
                    console.log(`🔄 ${member.name} 잔여시간 업데이트: ${remainingHours}시간 (D-${remainingDays})`);
                    
                    // 화면에서 잔여시간 표시 업데이트 (있다면)
                    const memberRow = document.querySelector(`[data-member-id="${memberId}"]`);
                    if (memberRow) {
                        const remainingTimeElement = memberRow.querySelector('.remaining-time');
                        if (remainingTimeElement) {
                            remainingTimeElement.textContent = `D-${remainingDays}/${remainingHours}시간`;
                        }
                    }
                }
            }
        }
        
        // 차감 기록을 데이터베이스에서 불러오는 함수
        function loadDeductedBlocks() {
            console.log('📚 차감 기록 불러오기 시작');
            fetch('api/save_deduction_record.php')
            .then(response => {
                console.log('API 응답 상태:', response.status);
                return response.text(); // JSON 대신 텍스트로 먼저 받기
            })
            .then(text => {
                console.log('API 응답 텍스트:', text);
                try {
                    const result = JSON.parse(text);
                    if (result.success && result.deductedBlocks) {
                        deductedBlocks = new Set(result.deductedBlocks);
                        console.log('✅ 차감 기록 로드 완료:', deductedBlocks.size, '개');
                    } else {
                        console.log('차감 기록이 없거나 로드 실패:', result);
                    }
                } catch (parseError) {
                    console.error('JSON 파싱 오류:', parseError);
                    console.log('원본 응답:', text);
                }
            })
            .catch(error => {
                console.error('❌ 차감 기록 로드 실패:', error);
            });
        }
        
        // 수동 테스트용 함수
        function testTimeDeduction() {
            console.log('🧪 수동 시간 차감 테스트 시작');
            const currentTime = new Date();
            const currentTimeInMinutes = currentTime.getHours() * 60 + currentTime.getMinutes() + 30 - 4;
            console.log('현재 시간 (30분 앞, 4분 뒤):', Math.floor(currentTimeInMinutes / 60) + ':' + (currentTimeInMinutes % 60));
            checkAndDeductReservationTime(currentTimeInMinutes);
        }
        
        // 강제 차감 테스트 (모든 예약 블록에 대해)
        function forceTimeDeduction() {
            console.log('🔥 강제 시간 차감 테스트 시작');
            const reservationBlocks = document.querySelectorAll('.reservation-block');
            console.log('발견된 예약 블록 수:', reservationBlocks.length);
            
            reservationBlocks.forEach((block, index) => {
                const memberId = block.getAttribute('data-member-id');
                const memberName = block.textContent || '알 수 없음';
                const memberType = block.getAttribute('data-member-type');
                const productHours = parseInt(block.getAttribute('data-product-hours')) || 0;
                
                console.log(`블록 ${index + 1}: ${memberName} (ID: ${memberId}, 타입: ${memberType}, 시간: ${productHours})`);
                
                if (memberId && memberType !== 'quick' && productHours > 0) {
                    // 강제로 30분 차감
                    fetch('api/simple_deduct_hours.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            memberId: memberId,
                            hoursToDeduct: 0.5
                        })
                    }).then(response => response.json())
                    .then(result => {
                        console.log(`✅ ${memberName} 강제 차감 결과:`, result);
                        if (result.success) {
                            updateMemberRemainingTime(memberId, result.new_used_hours);
                        }
                    }).catch(error => {
                        console.error(`❌ ${memberName} 차감 오류:`, error);
                    });
                }
            });
        }

        // 회원의 이용시간을 차감하는 함수
        function deductMemberHours(memberId, hoursToDeduct, reservationId, memberName = '알 수 없음') {
            console.log('🚀 API 호출 시작:', {
                회원이름: memberName,
                회원ID: memberId,
                차감시간: hoursToDeduct,
                예약ID: reservationId,
                url: 'api/deduct_member_hours.php'
            });
            
            fetch('api/deduct_member_hours.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    memberId: memberId,
                    hoursToDeduct: hoursToDeduct,
                    reservationId: reservationId
                })
            })
            .then(response => {
                return response.json();
            })
            .then(result => {
                if (result.success) {
                } else {
                    console.error('❌ 이용시간 차감 실패:', result.message);
                }
            })
            .catch(error => {
                console.error('💥 이용시간 차감 중 오류:', error);
            });
        }

        // 테스트용: 수동으로 시간 차감 테스트
        function testTimeDeduction() {
            console.log('🧪 수동 시간 차감 테스트 시작');
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;
            
            // 테스트를 위해 현재 시간을 1시간 후로 설정
            const testTimeInMinutes = currentTimeInMinutes + 60;
            
            console.log('테스트 시간:', Math.floor(testTimeInMinutes / 60) + ':' + (testTimeInMinutes % 60));
            checkAndDeductReservationTime(testTimeInMinutes);
        }

        // 네비게이션 토글 기능
        document.addEventListener('DOMContentLoaded', function() {
            // 모달이 자동으로 열리지 않도록 확실히 숨김
            const modal = document.getElementById('reservationModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('DOMContentLoaded: 모달 숨김 처리');
            }
            
            // 날짜 업데이트
            updateWeekDates();
            
            // 주간 네비게이션 버튼 이벤트 리스너 추가
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const todayBtn = document.getElementById('todayBtn');
            
            if (prevWeekBtn) {
                prevWeekBtn.addEventListener('click', goToPreviousWeek);
            }
            if (nextWeekBtn) {
                nextWeekBtn.addEventListener('click', goToNextWeek);
            }
            if (todayBtn) {
                todayBtn.addEventListener('click', goToToday);
            }
            
            // 헤더 영역 정리
            cleanupHeaderBlocks();
            
            // 캘린더 초기화 (예약 데이터 로드 포함)
            initializeCalendar();
            
            // 현재 시간 표시선 초기화 및 실시간 업데이트
            updateCurrentTimeLine();
            setInterval(() => {
                // 현재 주인지 확인 후에만 업데이트
                const today = new Date();
                const currentDay = today.getDay();
                const monday = new Date(today);
                monday.setDate(today.getDate() - currentDay + 1);
                monday.setHours(0, 0, 0, 0);
                const currentWeekStartNormalized = new Date(currentWeekStart);
                if (currentWeekStartNormalized) {
                    currentWeekStartNormalized.setHours(0, 0, 0, 0);
                }
                const isCurrentWeek = currentWeekStart && 
                    currentWeekStartNormalized.getTime() === monday.getTime();
                
                if (isCurrentWeek) {
                    updateCurrentTimeLine();
                } else {
                    console.log('🚫 다음주/이전주 - 차감 로직 실행 안함');
                }
            }, 60000); // 1분마다 업데이트
            
            // 스크롤 시 현재 시간 표시선 업데이트 (시간 차감 제외)
            const calendarWrapper = document.querySelector('.calendar-wrapper');
            if (calendarWrapper) {
                calendarWrapper.addEventListener('scroll', function() {
                    updateCurrentTimeLine(false); // 시간 차감 체크 제외
                });
            }
            
            const navParents = document.querySelectorAll('.nav__parent');
            navParents.forEach(parent => {
                parent.addEventListener('click', function() {
                    const children = this.nextElementSibling;
                    if (children) {
                        children.style.display = children.style.display === 'none' ? 'grid' : 'none';
                        this.classList.toggle('active');
                    }
                });
            });
            
            // 네비게이션 링크들이 정상적으로 작동하도록 보장
            const navLinks = document.querySelectorAll('.nav__child, .nav__item');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    console.log('네비게이션 링크 클릭:', href);
                    
                    // href가 #이 아닌 경우에만 페이지 이동
                    if (href && href !== '#') {
                        e.preventDefault(); // 기본 동작 방지
                        console.log('페이지 이동:', href);
                        window.location.href = href; // 직접 페이지 이동
                    }
                });
            });
        });

        // 회원 목록 불러오기 함수
        function loadMembers() {
            console.log('회원 목록 불러오기 시작');
            
            fetch('api/get_members.php')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        console.log('회원 데이터 로드 성공:', result.members.length + '명');
                        updateMemberSelect(result.members);
                    } else {
                        console.error('회원 데이터 로드 실패:', result.message);
                        updateMemberSelect([]);
                    }
                })
                .catch(error => {
                    console.error('회원 데이터 로드 오류:', error);
                    updateMemberSelect([]);
                });
        }

        // 전역 변수로 회원 데이터 저장
        let allMembers = [];

        // 회원 선택 옵션 업데이트 함수 (검색 기능으로 변경)
        function updateMemberSelect(members) {
            allMembers = members; // 전역 변수에 저장
            console.log('회원 데이터 저장 완료:', members.length + '명');
        }

        // 회원 검색 함수
        function searchMembers() {
            const searchInput = document.getElementById('memberSearchInput');
            const dropdown = document.getElementById('memberDropdown');
            const searchTerm = searchInput.value.toLowerCase().trim();

            if (!dropdown) return;

            // 검색어가 없으면 드롭다운 숨김
            if (!searchTerm) {
                dropdown.style.display = 'none';
                return;
            }

            // 회원 검색
            const filteredMembers = allMembers.filter(member => 
                member.name.toLowerCase().includes(searchTerm) ||
                (member.phone && member.phone.includes(searchTerm))
            );

            // 드롭다운 내용 업데이트
            dropdown.innerHTML = '';
            
            if (filteredMembers.length === 0) {
                const noResult = document.createElement('div');
                noResult.style.padding = '12px';
                noResult.style.color = '#666';
                noResult.textContent = '검색 결과가 없습니다.';
                dropdown.appendChild(noResult);
            } else {
                filteredMembers.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.style.padding = '12px';
                    memberItem.style.cursor = 'pointer';
                    memberItem.style.borderBottom = '1px solid #eee';
                    memberItem.innerHTML = `
                        <div style="font-weight: bold; color: #333;">${member.name}</div>
                        <div style="font-size: 14px; color: #666;">${member.product_name || member.product || '상품 정보 없음'}</div>
                    `;
                    
                    memberItem.addEventListener('click', function() {
                        selectMember(member);
                    });
                    
                    memberItem.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f5f5f5';
                    });
                    
                    memberItem.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                    });
                    
                    dropdown.appendChild(memberItem);
                });
            }

            dropdown.style.display = 'block';
        }

        // 회원 선택 함수
        function selectMember(member) {
            const searchInput = document.getElementById('memberSearchInput');
            const dropdown = document.getElementById('memberDropdown');
            const selectedMemberId = document.getElementById('selectedMemberId');
            const contactInput = document.getElementById('contactInput');

            // 입력 필드에 회원 이름 표시
            searchInput.value = member.name;
            
            // 숨겨진 필드에 회원 ID 저장
            selectedMemberId.value = member.id;
            
            // 연락처 자동 입력
            contactInput.value = member.phone || '';
            
            // 드롭다운 숨김
            dropdown.style.display = 'none';
            
            // 회원 상세 정보 로드
            loadMemberDetail(member.id);
            
            console.log('회원 선택됨:', member.name, member.id);
        }

        // 회원 검색 이벤트 설정
        function setupMemberSelectEvent() {
            const searchInput = document.getElementById('memberSearchInput');
            const dropdown = document.getElementById('memberDropdown');
            const contactInput = document.getElementById('contactInput');
            const memberDetailInfo = document.getElementById('memberDetailInfo');
            const productInput = document.getElementById('productInput');
            
            if (searchInput) {
                // 입력 시 검색 실행 (기존회원일 때만)
                searchInput.addEventListener('input', function() {
                    const memberType = document.querySelector('input[name="memberType"]:checked');
                    if (memberType && memberType.value === 'existing') {
                        searchMembers();
                    } else if (memberType && memberType.value === 'quick') {
                        // 비회원일 때는 검색하지 않고 드롭다운 숨김
                        if (dropdown) dropdown.style.display = 'none';
                    }
                });
                
                // 포커스 시 드롭다운 표시 (기존회원일 때만)
                searchInput.addEventListener('focus', function() {
                    const memberType = document.querySelector('input[name="memberType"]:checked');
                    if (memberType && memberType.value === 'existing' && this.value.trim()) {
                        searchMembers();
                    } else if (memberType && memberType.value === 'quick') {
                        // 비회원일 때는 드롭다운 숨김
                        if (dropdown) dropdown.style.display = 'none';
                    }
                });
                
                // 포커스 아웃 시 드롭다운 숨김 (약간의 지연)
                searchInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        if (dropdown) {
                            dropdown.style.display = 'none';
                        }
                    }, 200);
                });
            }
            
            // 외부 클릭 시 드롭다운 숨김
            document.addEventListener('click', function(e) {
                if (dropdown && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            // 회원 유형 변경 이벤트
            const memberTypeRadios = document.querySelectorAll('input[name="memberType"]');
            memberTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    handleMemberTypeChange(this.value);
                });
            });
            
            // 일정 유형 변경 이벤트 (바로가입(비회원) 선택 시 회원 유형도 자동 변경)
            const scheduleTypeRadios = document.querySelectorAll('input[name="scheduleType"]');
            scheduleTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'quick') {
                        // 바로가입(비회원) 선택 시 회원 유형도 바로가입(비회원)으로 변경
                        const quickMemberType = document.querySelector('input[name="memberType"][value="quick"]');
                        if (quickMemberType) {
                            quickMemberType.checked = true;
                            handleMemberTypeChange('quick');
                        }
                    }
                });
            });
        }
        
        // 회원 유형 변경 처리
        function handleMemberTypeChange(memberType, preserveValues = false) {
            const searchInput = document.getElementById('memberSearchInput');
            const dropdown = document.getElementById('memberDropdown');
            const contactInput = document.getElementById('contactInput');
            const productInput = document.getElementById('productInput');
            const selectedMemberId = document.getElementById('selectedMemberId');
            
            // 계속 예약 모드가 아니면 필드 초기화
            if (!preserveValues) {
                if (searchInput) searchInput.value = '';
                if (contactInput) contactInput.value = '';
                if (productInput) productInput.value = '';
                if (selectedMemberId) selectedMemberId.value = '';
            }
            if (dropdown) dropdown.style.display = 'none';
            
            // 회원 상세 정보 숨기기
            hideMemberDetail();
            
            if (memberType === 'quick') {
                // 비회원: 검색 기능 비활성화, 입력만 가능
                if (searchInput) {
                    searchInput.placeholder = '회원 이름을 작성해주세요';
                    searchInput.readOnly = false;
                }
                console.log('비회원 모드로 전환');
            } else {
                // 기존회원: 검색 기능 활성화
                if (searchInput) {
                    searchInput.placeholder = '회원을 검색하세요';
                    searchInput.readOnly = false;
                }
                console.log('기존회원 모드로 전환');
            }
        }

        // 회원 상세 정보 불러오기 함수
        function loadMemberDetail(memberId) {
            console.log('회원 상세 정보 불러오기:', memberId);
            
            fetch(`api/debug_member_detail.php?id=${memberId}`)
                .then(response => {
                    console.log('API 응답 상태:', response.status);
                    return response.json();
                })
                .then(result => {
                    console.log('API 응답 데이터:', result);
                    if (result.success) {
                        console.log('회원 상세 정보 로드 성공:', result.member);
                        console.log('상품 정보 확인:', {
                            productName: result.member.productName,
                            product_name: result.member.product_name,
                            product: result.member.product
                        });
                        displayMemberDetail(result.member);
                    } else {
                        console.error('회원 상세 정보 로드 실패:', result.message);
                        hideMemberDetail();
                    }
                })
                .catch(error => {
                    console.error('회원 상세 정보 로드 오류:', error);
                    hideMemberDetail();
                });
        }

        // 회원 상세 정보 표시 함수
        function displayMemberDetail(member) {
            console.log('회원 상세 정보 표시:', member);
            
            const productInput = document.getElementById('productInput');
            const contactInput = document.getElementById('contactInput');
            
            // 시험 일정 로드
            loadTestSchedule(member);
            
            // 교육 메모 로드
            console.log('교육 메모 데이터 확인:', {
                education_memos: member.education_memos,
                type: typeof member.education_memos,
                length: member.education_memos ? member.education_memos.length : 0
            });
            
            if (member.education_memos && Array.isArray(member.education_memos) && member.education_memos.length > 0) {
                console.log('교육 메모 로드 성공:', member.education_memos);
                loadEducationMemos(member.education_memos);
            } else {
                console.log('교육 메모가 없거나 비어있음');
                clearEducationMemos();
            }
            
            // 상품 입력 필드에 회원의 상품명 자동 입력
            if (productInput) {
                const productName = member.productName || member.product_name || member.product;
                console.log('상품 정보 설정:', {
                    productName: member.productName,
                    product_name: member.product_name,
                    product: member.product,
                    최종사용값: productName
                });
                
                // 상품 정보가 있을 때만 설정
                if (productName && productName.trim() !== '' && productName !== '상품을 선택하세요') {
                    productInput.value = productName;
                    console.log('상품 정보 설정됨:', productName);
                } else {
                    console.log('상품 정보가 없거나 유효하지 않음:', productName);
                    // 기본값으로 설정하지 않음
                }
            } else {
                console.error('productInput 요소를 찾을 수 없습니다.');
            }
            
            // 연락처 필드에 회원의 전화번호 자동 입력
            if (contactInput && member.phone) {
                contactInput.value = member.phone;
            }
            
            console.log('회원 상세 정보 로드 완료');
        }
        
        // 시험 일정 로드 함수
        function loadTestSchedule(member) {
            const functionTestDate = document.getElementById('functionTestDate');
            const roadTestDate = document.getElementById('roadTestDate');
            
            if (functionTestDate && roadTestDate) {
                // 기능 시험 일정 설정
                if (member.indoorTestDate && member.indoorTestDate !== '-') {
                    functionTestDate.value = member.indoorTestDate;
                    functionTestDate.style.background = '#fff';
                    functionTestDate.style.color = '#333';
                } else {
                    functionTestDate.value = '';
                    functionTestDate.style.background = '#f8f9fa';
                    functionTestDate.style.color = '#6c757d';
                }
                
                // 주행 시험 일정 설정
                if (member.roadTestDate && member.roadTestDate !== '-') {
                    roadTestDate.value = member.roadTestDate;
                    roadTestDate.style.background = '#fff';
                    roadTestDate.style.color = '#333';
                } else {
                    roadTestDate.value = '';
                    roadTestDate.style.background = '#f8f9fa';
                    roadTestDate.style.color = '#6c757d';
                }
            }
        }

        // 회원 상세 정보 숨기기 함수
        function hideMemberDetail() {
            // 시험 일정 필드 초기화
            const functionTestDate = document.getElementById('functionTestDate');
            const roadTestDate = document.getElementById('roadTestDate');
            
            if (functionTestDate) {
                functionTestDate.value = '';
                functionTestDate.style.background = '#f8f9fa';
                functionTestDate.style.color = '#6c757d';
            }
            
            if (roadTestDate) {
                roadTestDate.value = '';
                roadTestDate.style.background = '#f8f9fa';
                roadTestDate.style.color = '#6c757d';
            }
            
            // 연락처 필드 초기화
            const contactInput = document.getElementById('contactInput');
            if (contactInput) {
                contactInput.value = '';
            }
        }

        // 교육 메모 추가 기능
        function setupEducationMemoFeature() {
            const addBtn = document.getElementById('addEducationMemoBtn');
            const container = document.getElementById('educationMemosContainer');
            
            if (addBtn && container) {
                // 기존 이벤트 리스너 제거 (중복 방지)
                addBtn.removeEventListener('click', handleAddEducationMemo);
                
                // 새로운 이벤트 리스너 등록
                addBtn.addEventListener('click', handleAddEducationMemo);
            }
        }
        
        // 교육 메모 추가 핸들러 (별도 함수로 분리)
        function handleAddEducationMemo() {
            addEducationMemoItem();
        }

        // 시험 일정 필드 이벤트 설정
        function setupTestScheduleFields() {
            const functionTestDate = document.getElementById('functionTestDate');
            const roadTestDate = document.getElementById('roadTestDate');
            
            // 기능 시험 필드 이벤트
            if (functionTestDate) {
                functionTestDate.addEventListener('focus', function() {
                    this.style.background = '#fff';
                    this.style.color = '#333';
                });
                
                functionTestDate.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.background = '#f8f9fa';
                        this.style.color = '#6c757d';
                    }
                });
            }
            
            // 주행 시험 필드 이벤트
            if (roadTestDate) {
                roadTestDate.addEventListener('focus', function() {
                    this.style.background = '#fff';
                    this.style.color = '#333';
                });
                
                roadTestDate.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.background = '#f8f9fa';
                        this.style.color = '#6c757d';
                    }
                });
            }
        }

        // 교육 메모 항목 추가
        function addEducationMemoItem() {
            const container = document.getElementById('educationMemosContainer');
            if (!container) return;

            // 현재 예약의 날짜를 기준으로 설정
            let dateStr = new Date().toISOString().split('T')[0]; // 기본값: 오늘
            
            // 예약 모달에서 현재 선택된 날짜 정보 가져오기
            const modal = document.getElementById('reservationModal');
            if (modal) {
                const reservationData = currentReservationData || JSON.parse(modal.getAttribute('data-reservation') || '{}');
                
                // 실제 날짜가 있으면 사용, 없으면 targetDay로 계산
                
                if (reservationData.actualDate) {
                    dateStr = reservationData.actualDate;
                } else if (reservationData.targetDay !== undefined) {
                    // targetDay는 0(월요일)부터 6(일요일)까지의 값
                    const currentWeek = getCurrentWeek();
                    const targetDate = new Date(currentWeek[reservationData.targetDay]);
                    dateStr = targetDate.toISOString().split('T')[0];
                } else {
                    // targetDay도 없으면 현재 주의 요일을 추정해서 계산
                    
                    // 현재 주의 날짜들을 확인하여 가장 가까운 날짜 사용
                    const currentWeek = getCurrentWeek();
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    
                    // 현재 주에서 오늘과 가장 가까운 날짜 찾기
                    let closestDate = null;
                    let minDiff = Infinity;
                    
                    currentWeek.forEach((date, index) => {
                        const dateStr = date.toISOString().split('T')[0];
                        const diff = Math.abs(new Date(dateStr) - new Date(todayStr));
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestDate = dateStr;
                        }
                    });
                    
                    if (closestDate) {
                        dateStr = closestDate;
                    } else {
                    }
                }
            } else {
            }
            
            const memoItem = document.createElement('div');
            memoItem.className = 'education-memo-item';
            memoItem.style.cssText = `
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                transition: all 0.2s ease;
            `;
            
            memoItem.innerHTML = `
                <div style="display: flex; gap: 12px; align-items: flex-start;">
                    <input type="date" value="${dateStr}" style="flex: 0 0 140px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: #f9fafb; color: #374151; font-weight: 500;">
                    <textarea placeholder="교육 내용을 입력하세요..." style="flex: 1; padding: 10px 12px; border: 2px solid #000; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 80px; font-family: inherit; line-height: 1.5; background: white; color: #111827;"></textarea>
                    <div style="display: flex; gap: 8px; flex-direction: column;">
                        <button type="button" onclick="saveEducationMemoItem(this)" style="background: #10b981; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);" onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 2px rgba(0, 0, 0, 0.1)'">저장</button>
                        <button type="button" onclick="removeEducationMemoItem(this)" style="background: #ef4444; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);" onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.background='#ef4444'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 2px rgba(0, 0, 0, 0.1)'">삭제</button>
                    </div>
                </div>
            `;
            
            container.appendChild(memoItem);
            
            // 스크롤을 맨 아래로
            container.scrollTop = container.scrollHeight;
        }

        // 교육 메모 항목 삭제
        window.removeEducationMemoItem = function(button) {
            const memoItem = button.closest('.education-memo-item');
            if (!memoItem) return;

            // 현재 예약 데이터에서 회원 ID 가져오기
            const modal = document.getElementById('reservationModal');
            const reservationData = currentReservationData || JSON.parse(modal.getAttribute('data-reservation') || '{}');
            
            console.log('삭제 시 예약 데이터:', reservationData);
            
            // 여러 필드에서 회원 ID 찾기
            const memberId = reservationData.memberId || reservationData.member_id || 
                           document.getElementById('selectedMemberId')?.value;

            console.log('찾은 회원 ID:', memberId);

            if (!memberId) {
                alert('회원 정보를 찾을 수 없습니다. 예약 모달을 다시 열어주세요.');
                return;
            }

            // 현재 교육 메모 목록에서 삭제할 항목의 인덱스 찾기
            const memoItems = document.querySelectorAll('.education-memo-item');
            const currentIndex = Array.from(memoItems).indexOf(memoItem);
            
            if (currentIndex === -1) {
                console.error('삭제할 메모 항목을 찾을 수 없습니다.');
                return;
            }

            // 현재 교육 메모 목록 가져오기
            const currentMemos = getEducationMemos();
            
            // 해당 인덱스의 메모 제거
            if (currentIndex < currentMemos.length) {
                currentMemos.splice(currentIndex, 1);
                
                // 서버에 업데이트된 교육 메모 목록 저장
                updateMemberEducationMemos(memberId, currentMemos)
                    .then(() => {
                        // 서버 저장 성공 후 UI에서 제거
                        memoItem.remove();
                        console.log('교육 메모 삭제 완료');
                    })
                    .catch(error => {
                        console.error('교육 메모 삭제 실패:', error);
                        alert('교육 메모 삭제에 실패했습니다.');
                    });
            } else {
                // 인덱스가 범위를 벗어나면 UI에서만 제거
                memoItem.remove();
            }
        };

        // 교육 메모 항목 저장
        window.saveEducationMemoItem = function(button) {
            const memoItem = button.closest('.education-memo-item');
            if (!memoItem) return;

            const dateInput = memoItem.querySelector('input[type="date"]');
            const textarea = memoItem.querySelector('textarea');
            
            if (!dateInput || !textarea) {
                alert('날짜와 내용을 모두 입력해주세요.');
                return;
            }

            const date = dateInput.value;
            const content = textarea.value.trim();

            if (!date || !content) {
                alert('날짜와 내용을 모두 입력해주세요.');
                return;
            }

            // 현재 예약 데이터에서 회원 ID 가져오기
            const modal = document.getElementById('reservationModal');
            const reservationData = currentReservationData || JSON.parse(modal.getAttribute('data-reservation') || '{}');
            
            console.log('저장 시 예약 데이터:', reservationData);
            
            // 여러 필드에서 회원 ID 찾기
            const memberId = reservationData.memberId || reservationData.member_id || 
                           document.getElementById('selectedMemberId')?.value;

            console.log('찾은 회원 ID:', memberId);

            if (!memberId) {
                alert('회원 정보를 찾을 수 없습니다. 예약 모달을 다시 열어주세요.');
                return;
            }

            // 현재 교육 메모 목록 가져오기
            const currentMemos = getEducationMemos();
            
            // 현재 항목의 인덱스 찾기 (기존 항목인지 새 항목인지 확인)
            const memoItems = document.querySelectorAll('.education-memo-item');
            const currentIndex = Array.from(memoItems).indexOf(memoItem);
            
            // 현재 항목의 데이터로 업데이트
            const updatedMemo = {
                date: date,
                content: content
            };

            // 기존 항목인 경우 업데이트, 새 항목인 경우 추가
            if (currentIndex < currentMemos.length) {
                currentMemos[currentIndex] = updatedMemo;
            } else {
                currentMemos.push(updatedMemo);
            }

            // 서버에 저장
            updateMemberEducationMemos(memberId, currentMemos)
                .then(() => {
                    // 저장 성공 시 버튼 스타일 변경
                    button.style.background = '#059669';
                    button.textContent = '저장됨';
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.style.background = '#10b981';
                        button.textContent = '저장';
                        button.disabled = false;
                    }, 2000);
                })
                .catch(error => {
                    console.error('교육 메모 저장 실패:', error);
                    alert('교육 메모 저장에 실패했습니다.');
                });
        };

        // 교육 메모 데이터 수집
        function getEducationMemos() {
            const container = document.getElementById('educationMemosContainer');
            if (!container) return [];

            const memos = [];
            const memoItems = container.querySelectorAll('.education-memo-item');
            
            memoItems.forEach(item => {
                const dateInput = item.querySelector('input[type="date"]');
                const textarea = item.querySelector('textarea');
                
                if (dateInput && textarea && textarea.value.trim()) {
                    memos.push({
                        date: dateInput.value,
                        content: textarea.value.trim()
                    });
                }
            });
            
            return memos;
        }

        // 교육 메모 데이터 로드
        function loadEducationMemos(memos) {
            const container = document.getElementById('educationMemosContainer');
            if (!container) return;

            // 기존 메모 제거
            container.innerHTML = '';

            if (memos && memos.length > 0) {
                memos.forEach(memo => {
                    const memoItem = document.createElement('div');
                    memoItem.className = 'education-memo-item';
                    memoItem.style.cssText = `
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        transition: all 0.2s ease;
                    `;
                    
                    memoItem.innerHTML = `
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <input type="date" value="${memo.date}" style="flex: 0 0 140px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: #f9fafb; color: #374151; font-weight: 500;">
                            <textarea style="flex: 1; padding: 10px 12px; border: 2px solid #000; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 80px; font-family: inherit; line-height: 1.5; background: white; color: #111827;">${memo.content}</textarea>
                            <div style="display: flex; gap: 8px; flex-direction: column;">
                                <button type="button" onclick="saveEducationMemoItem(this)" style="background: #10b981; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);" onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 2px rgba(0, 0, 0, 0.1)'">저장</button>
                                <button type="button" onclick="removeEducationMemoItem(this)" style="background: #ef4444; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);" onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.background='#ef4444'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 2px rgba(0, 0, 0, 0.1)'">삭제</button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(memoItem);
                });
            }
        }

        // 교육 메모 초기화
        function clearEducationMemos() {
            const container = document.getElementById('educationMemosContainer');
            if (!container) return;

            // 기존 메모 제거
            container.innerHTML = '';
        }

        // 회원의 교육 메모를 데이터베이스에 저장
        function updateMemberEducationMemos(memberId, educationMemos) {
            console.log('교육 메모 저장 시도:', {
                memberId: memberId,
                educationMemos: educationMemos,
                educationMemosLength: educationMemos ? educationMemos.length : 0
            });
            
            return fetch('api/update_member_education_memos.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    memberId: memberId,
                    educationMemos: educationMemos
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('교육 메모 저장 성공:', data);
                    return data;
                } else {
                    console.error('교육 메모 저장 실패:', data.message);
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('교육 메모 저장 중 오류:', error);
                throw error;
            });
        }

        // 새로운 예약 시스템 변수
        const timeSlots = [
            '9:00', '9:30', '10:00', '10:30', '11:00', '11:30', '12:00',
            '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30',
            '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00',
            '19:30', '20:00', '20:30', '21:00', '21:30', '22:00', '22:30',
            '23:00', '23:30', '24:00', 'NULL'
        ];
        
        let dragState = {
            isActive: false,
            startTime: null,
            startSlot: null,
            endTime: null,
            startDay: null
        };
        
        // 예약 블록 생성을 위한 영구 저장 변수
        let reservationInfo = {
            day: null,
            seat: null
        };
        
        let currentReservationData = null; // 현재 수정 중인 예약 데이터
        
        // 색상 클래스 결정 함수
        function determineColorClass(scheduleType, productName, productHours) {
            console.log('색상 클래스 결정:', {
                scheduleType,
                productName,
                productHours,
                productHoursType: typeof productHours
            });
            
            // 결석 처리인 경우 빨간색
            if (scheduleType === 'absent') {
                console.log('결석 색상 반환');
                return 'absent';
            }
            // 상품이 없는 경우 (비회원)
            else if (scheduleType === 'no-product' || !productName || productName.trim() === '') {
                console.log('비회원 색상 반환');
                return 'none';
            }
            // 상품이 있는 경우 product_hours로 색상 결정
            else if (productHours !== undefined && productHours !== null) {
                const hours = Number(productHours);
                console.log('productHours로 색상 결정:', hours);
                
                // productHours가 0이지만 상품명에 시간 정보가 있으면 시간제로 처리
                if (hours === 0 && productName && (productName.includes('시간') || productName.includes('hour'))) {
                    console.log('상품명에 시간 정보가 있어서 시간제 색상 반환');
                    return 'time'; // 보라색 - 시간제
                }
                else if (hours === 0) {
                    console.log('무제한 색상 반환');
                    return 'unlimited'; // 녹색 - 무제한
                } else if (hours > 0) {
                    console.log('시간제 색상 반환');
                    return 'time'; // 보라색 - 시간제
                }
            }
            // product_hours가 없는 경우 상품명으로 판단
            else if (productName) {
                const product = productName.toLowerCase();
                console.log('상품명으로 색상 판단:', product);
                
                if (product.includes('무제한') || product.includes('unlimited')) {
                    console.log('상품명으로 무제한 색상 반환');
                    return 'unlimited';
                } else if (product.includes('시간') || product.includes('hour') || product.includes('시간형')) {
                    console.log('상품명으로 시간제 색상 반환');
                    return 'time';
                }
            }
            
            console.log('기본 색상 반환');
            return 'custom'; // 기본 색상
        }
        
        // 모든 예약 블록의 색상을 업데이트하는 함수
        function updateAllReservationBlockColors() {
            const reservationBlocks = document.querySelectorAll('.reservation-block');
            
            reservationBlocks.forEach((block, index) => {
                const reservationId = block.getAttribute('data-reservation-id');
                if (reservationId) {
                    // 서버에서 예약 정보를 가져와서 색상 업데이트
                    fetch(`api/get_reservations.php`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                const reservation = result.reservations.find(r => r.id == reservationId);
                                if (reservation) {
                                    const newColorClass = determineColorClass(
                                        reservation.scheduleType,
                                        reservation.productName || reservation.product_name,
                                        reservation.product_hours
                                    );
                                    
                                    // 기존 색상 클래스 제거
                                    block.classList.remove('custom', 'time', 'none', 'unlimited', 'course', 'absent');
                                    // 새로운 색상 클래스 추가
                                    block.classList.add(newColorClass);
                                    block.className = `reservation-block ${newColorClass}`;
                                    
                                    // 인라인 background 스타일 제거 (CSS 클래스가 우선되도록)
                                    block.style.removeProperty('background');
                                    block.style.removeProperty('background-color');
                                    
                                }
                            }
                        })
                        .catch(error => {
                            console.error('예약 정보 로드 실패:', error);
                        });
                }
            });
        }

        // 새로운 캘린더 초기화 함수
        function initializeCalendar() {
            console.log('캘린더 초기화 시작');
            
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = ''; // 기존 내용 삭제
            
            // 4자리 시스템으로 캘린더 생성
            timeSlots.forEach((time, timeIndex) => {
                // 시간 슬롯
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = time;
                calendarBody.appendChild(timeSlot);

                // 각 요일별 4자리 시스템
                for (let day = 1; day <= 7; day++) {
                    // 요일 컬럼 컨테이너
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'day-column';
                    dayColumn.setAttribute('data-day', day);
                    
                    // 6개 좌석 생성
                    for (let seat = 1; seat <= 6; seat++) {
                        const slot = document.createElement('div');
                        slot.className = 'reservation-slot';
                        slot.setAttribute('data-time-index', timeIndex);
                        slot.setAttribute('data-day', day);
                        slot.setAttribute('data-seat', seat);
                        
                        // 오늘 날짜인지 확인하여 today 클래스 추가 (10/1 수요일 = data-day="3")
                        const today = new Date();
                        const currentDay = today.getDay(); // 0=일요일, 1=월요일, ..., 6=토요일
                        
                        // 현재 표시 중인 주가 오늘의 주인지 확인
                        const monday = new Date(today);
                        monday.setDate(today.getDate() - currentDay + 1);
                        monday.setHours(0, 0, 0, 0);
                        
                        const isCurrentWeek = currentWeekStart && 
                            currentWeekStart.getTime() === monday.getTime();
                        
                        // 오늘 날짜인지 확인 (수요일 = day 3)
                        const isToday = isCurrentWeek && (day === 3);
                        
                        if (isToday) {
                            slot.classList.add('today');
                            console.log('수요일(10/1) 셀에 today 클래스 추가');
                        }
                        
                        dayColumn.appendChild(slot);
                    }
                    
                    calendarBody.appendChild(dayColumn);
                }
            });
            
            // 드래그 이벤트 초기화
            initializeDragEvents();
            
            
            // 헤더와 본문 스크롤 동기화
            initializeScrollSync();
            
            // 모달 이벤트 초기화
            initializeModalEvents();
            
            // 차감 기록 불러오기 (임시 비활성화)
            // loadDeductedBlocks();
            
            // 캘린더 초기화 완료 후 예약 데이터 로드
            console.log('캘린더 초기화 완료, 예약 데이터 로드 시작');
            loadReservationsOnPageLoad();
        }
        
        // 헤더와 본문 스크롤 동기화 함수
        function initializeScrollSync() {
            const calendarWrapper = document.querySelector('.calendar-wrapper');
            const calendarHeader = document.querySelector('.calendar-header');
            const calendarBody = document.getElementById('calendarBody');
            
            if (calendarWrapper && calendarHeader && calendarBody) {
                // 래퍼 스크롤 시 헤더와 본문이 함께 움직임 (자동)
                console.log('스크롤 동기화 설정 완료 - 래퍼 방식');
            }
        }
        
        // 모달 이벤트 초기화
        function initializeModalEvents() {
            const modal = document.getElementById('reservationModal');
            if (!modal) {
                console.error('reservationModal을 찾을 수 없습니다');
                return;
            }
            
            const closeBtn = modal.querySelector('.modal__close');
            const cancelBtn = modal.querySelector('.btn--cancel');
            
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
            
            // 모달 배경 클릭 시 닫기
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // 예약 수정 모달 이벤트 초기화
            initializeEditModalEvents();
        }
        
        // 예약 수정 모달 이벤트 초기화
        function initializeEditModalEvents() {
            // 이 함수는 이제 사용하지 않음 - setupEditModeButtons로 대체
        }
        
        // 수정 모드 버튼 이벤트 리스너 설정
        function setupEditModeButtons() {
            const deleteBtn = document.getElementById('deleteReservationBtn');
            const absentBtn = document.getElementById('markAbsentBtn');
            const updateBtn = document.getElementById('updateReservationBtn');
            
            console.log('수정 모드 버튼 설정:', { deleteBtn, absentBtn, updateBtn });
            
            // 기존 이벤트 리스너 제거
            if (deleteBtn) {
                deleteBtn.removeEventListener('click', deleteReservation);
                deleteBtn.addEventListener('click', deleteReservation);
            }
            if (absentBtn) {
                absentBtn.removeEventListener('click', markAbsent);
                absentBtn.addEventListener('click', markAbsent);
            }
            if (updateBtn) {
                updateBtn.removeEventListener('click', updateReservation);
                updateBtn.addEventListener('click', updateReservation);
            }
        }
        
        // 결석 처리 함수
        function markAbsent() {
            console.log('결석 처리 시작');
            
            if (!currentReservationData) {
                alert('예약 정보를 찾을 수 없습니다.');
                return;
            }
            
            if (confirm('이 예약을 결석 처리하시겠습니까?')) {
                // 예약 블록을 결석 처리로 변경
                const reservationId = currentReservationData.id;
                
                // 서버에서 예약을 결석 처리로 업데이트
                updateReservationOnServer(reservationId, {
                    ...currentReservationData,
                    scheduleType: 'absent'
                }).then(() => {
                    // 예약 블록의 색상을 빨간색으로 변경
                    const reservationBlock = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                    if (reservationBlock) {
                        // 기존 색상 클래스 제거
                        reservationBlock.classList.remove('custom', 'time', 'none', 'unlimited', 'course');
                        // 결석 색상 클래스 추가
                        reservationBlock.classList.add('absent');
                        reservationBlock.className = 'reservation-block absent';
                        
                        console.log('예약 블록이 결석 처리로 변경됨');
                    }
                    
                    alert('결석 처리되었습니다.');
                    closeModal();
                }).catch(error => {
                    console.error('결석 처리 실패:', error);
                    alert('결석 처리 중 오류가 발생했습니다: ' + error.message);
                });
            }
        }
        
        // 새로운 드래그 이벤트 초기화
        function initializeDragEvents() {
            const calendarBody = document.getElementById('calendarBody');
            
            // 전역 마우스 이벤트 (마우스가 캘린더 밖으로 나갔을 때)
            document.addEventListener('mouseup', function(e) {
                if (dragState.startTime !== null) {
                    finishDrag();
                }
            });
            
            // ESC 키로 드래그 취소
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && dragState.startTime !== null) {
                    resetDragState();
                }
            });
            
            // 마우스 다운 이벤트
            calendarBody.addEventListener('mousedown', function(e) {
                if (e.button !== 0) return; // 좌클릭만
                
                const slot = findSlotAtPosition(e.clientX, e.clientY);
                if (!slot) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // 기존 드래그 상태 초기화
                resetDragState();
                
                // 시작 정보 저장
                const timeInfo = getTimeFromSlot(slot);
                dragState.startTime = timeInfo.timeIndex;
                dragState.startSlot = slot;
                dragState.startDay = timeInfo.day;
                dragState.isActive = false;
                
                // 예약 정보 영구 저장
                reservationInfo.day = timeInfo.day;
                reservationInfo.seat = parseInt(slot.getAttribute('data-seat'));
                
                
                // 요일 확인
                const dayNames = ['월', '화', '수', '목', '금', '토', '일'];
                
                // reservationInfo가 제대로 설정되었는지 확인
                if (!reservationInfo.day || !reservationInfo.seat) {
                    reservationInfo.day = parseInt(slot.getAttribute('data-day'));
                    reservationInfo.seat = parseInt(slot.getAttribute('data-seat'));
                }
                
                const seat = parseInt(slot.getAttribute('data-seat'));
            });
            
            // 마우스 이동 이벤트
            calendarBody.addEventListener('mousemove', function(e) {
                // 마우스 버튼이 눌려있지 않으면 드래그 종료
                if (e.buttons !== 1) {
                    if (dragState.isActive || dragState.startTime !== null) {
                        finishDrag();
                    }
                    return;
                }
                
                // 드래그 시작 (마우스가 움직이기 시작할 때)
                if (dragState.startTime !== null && !dragState.isActive) {
                    console.log('드래그 시작 트리거');
                    startDrag();
                }
                
                // 드래그 중이 아니면 리턴
                if (!dragState.isActive) return;
                
                
                // 현재 마우스 위치의 시간 정보 가져오기
                const timeInfo = getTimeFromPosition(e.clientX, e.clientY);
                if (!timeInfo) {
                    console.log('시간 정보 없음');
                    return;
                }
                
                // 시작 시간보다 이후 시간만 선택 가능
                if (timeInfo.timeIndex <= dragState.startTime) {
                    console.log('시작 시간보다 이전:', timeInfo.timeIndex, '<=', dragState.startTime);
                    return;
                }
                
                // 같은 좌석 열에서만 드래그 가능
                const currentSlot = findSlotAtPosition(e.clientX, e.clientY);
                if (!currentSlot) {
                    console.log('현재 슬롯 없음');
                    return;
                }
                
                if (!isSameSeatColumn(dragState.startSlot, currentSlot)) {
                    console.log('다른 좌석 열');
                    return;
                }
                
                // 종료 시간 업데이트
                dragState.endTime = timeInfo.timeIndex;
                updateDragVisual();
            });
        }
        
        // 유틸리티 함수들
        function findSlotAtPosition(x, y) {
            const allSlots = document.querySelectorAll('.reservation-slot');
            for (let slot of allSlots) {
                const rect = slot.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return slot;
                }
            }
            return null;
        }
        
        // 특정 좌석의 세로 열 찾기 (같은 요일, 같은 좌석 번호)
        function findSeatColumn(startSlot) {
            const startDay = parseInt(startSlot.getAttribute('data-day'));
            const startSeat = parseInt(startSlot.getAttribute('data-seat'));
            
            const allSlots = document.querySelectorAll('.reservation-slot');
            const seatColumn = [];
            
            allSlots.forEach(slot => {
                const day = parseInt(slot.getAttribute('data-day'));
                const seat = parseInt(slot.getAttribute('data-seat'));
                
                if (day === startDay && seat === startSeat) {
                    seatColumn.push(slot);
                }
            });
            
            return seatColumn.sort((a, b) => {
                const timeA = parseInt(a.getAttribute('data-time-index'));
                const timeB = parseInt(b.getAttribute('data-time-index'));
                return timeA - timeB;
            });
        }
        
        // 같은 좌석 열인지 확인
        function isSameSeatColumn(slot1, slot2) {
            const day1 = parseInt(slot1.getAttribute('data-day'));
            const seat1 = parseInt(slot1.getAttribute('data-seat'));
            const day2 = parseInt(slot2.getAttribute('data-day'));
            const seat2 = parseInt(slot2.getAttribute('data-seat'));
            
            return day1 === day2 && seat1 === seat2;
        }
        
        function getTimeFromSlot(slot) {
            const timeIndex = parseInt(slot.getAttribute('data-time-index'));
            const day = parseInt(slot.getAttribute('data-day'));
            
            
            return {
                timeIndex: timeIndex,
                timeText: timeSlots[timeIndex] || 'unknown',
                day: day
            };
        }
        
        function getTimeFromPosition(x, y) {
            const slot = findSlotAtPosition(x, y);
            return slot ? getTimeFromSlot(slot) : null;
        }
        
        function startDrag() {
            dragState.isActive = true;
            console.log('드래그 시작');
            
            // 시간 표시기 생성
            createTimeIndicator();
        }
        
        function updateDragVisual() {
            if (dragState.endTime && dragState.endTime > dragState.startTime) {
                console.log('드래그 중:', dragState.startTime, '~', dragState.endTime);
                
                // 시간 표시기 업데이트
                updateTimeIndicator();
                
                // 임시 예약 블록 표시 (같은 좌석 열에서만)
                updateTempReservation(dragState.startTime, dragState.endTime);
            }
        }
        
        function finishDrag() {
            console.log('드래그 종료');
            console.log('드래그 상태:', dragState);
            
            if (dragState.startTime !== null) {
                // reservationInfo 업데이트 (드래그 종료 시점에서)
                if (dragState.startSlot) {
                    const timeInfo = getTimeFromSlot(dragState.startSlot);
                    reservationInfo.day = timeInfo.day;
                    reservationInfo.seat = parseInt(dragState.startSlot.getAttribute('data-seat'));
                    console.log('🔧 finishDrag에서 reservationInfo 업데이트:', reservationInfo);
                }
                
                if (dragState.isActive && dragState.endTime && dragState.endTime > dragState.startTime) {
                    // 실제 드래그: 선택한 시간대로 예약
                    console.log('드래그 예약:', dragState.startTime, '~', dragState.endTime, '요일:', dragState.startDay);
                    openReservationModal(dragState.startTime, dragState.endTime, dragState.startDay);
                } else {
                    // 단일 클릭: 30분 예약
                    console.log('단일 클릭 30분 예약:', dragState.startTime, '요일:', dragState.startDay);
                    openReservationModal(dragState.startTime, dragState.startTime + 1, dragState.startDay);
                }
            }
            
            resetDragState();
        }
        
        function resetDragState() {
            dragState.isActive = false;
            dragState.startTime = null;
            dragState.startSlot = null;
            dragState.endTime = null;
            dragState.startDay = null;
            
            // 시각적 요소들 정리
            cleanupDrag();
        }
        
        // 간단한 모달 함수들
        function openReservationModal(startTime, endTime, targetDay = null) {
            console.log('모달 열기:', startTime, endTime, '요일:', targetDay);
            const modal = document.getElementById('reservationModal');
            
            // 드래그한 시간을 시작시간과 종료시간에 자동 설정
            let startHour = Math.floor(startTime * 0.5) + 9;
            let startMinute = (startTime * 0.5) % 1 === 0 ? '00' : '30';
            
            // 24시 표시 처리 (시작시간)
            if (startHour >= 24) {
                startHour = 24;
                startMinute = '00';
            }
            
            // 단일 클릭(30분 예약)과 드래그 구분
            let endHour, endMinute;
            if (endTime === startTime + 1) {
                // 단일 클릭: 30분 예약 (30분 빼지 않음)
                endHour = Math.floor(endTime * 0.5) + 9;
                endMinute = (endTime * 0.5) % 1 === 0 ? '00' : '30';
            } else {
                // 드래그: 선택한 시간대로 예약 (30분 빼기)
                endHour = Math.floor((endTime - 1) * 0.5) + 9;
                endMinute = ((endTime - 1) * 0.5) % 1 === 0 ? '00' : '30';
            }
            
            // 24시 표시 처리 (24:00이 00:00으로 표시되는 문제 해결)
            if (endHour >= 24) {
                endHour = 24;
                endMinute = '00';
            }
            
            console.log('시간 변환:', {
                startTime: startTime,
                endTime: endTime,
                startHour: startHour,
                startMinute: startMinute,
                endHour: endHour,
                endMinute: endMinute
            });
            
            // 시작시간 설정
            const startHourSelect = document.getElementById('startHour');
            const startMinuteSelect = document.getElementById('startMinute');
            if (startHourSelect && startMinuteSelect) {
                startHourSelect.value = startHour.toString().padStart(2, '0');
                startMinuteSelect.value = startMinute;
                console.log('시작시간 설정:', startHour + ':' + startMinute);
            }
            
            // 종료시간 설정 (30분 추가)
            const endHourSelect = document.getElementById('endHour');
            const endMinuteSelect = document.getElementById('endMinute');
            if (endHourSelect && endMinuteSelect) {
                // 30분 추가
                let displayEndHour = endHour;
                let displayEndMinute = endMinute;
                
                if (endMinute === '30') {
                    displayEndHour = endHour + 1;
                    displayEndMinute = '00';
                } else {
                    displayEndMinute = '30';
                }
                
                // 24시 넘어가면 24시로 제한
                if (displayEndHour >= 24) {
                    displayEndHour = 23;
                    displayEndMinute = '30';
                }
                
                endHourSelect.value = displayEndHour.toString().padStart(2, '0');
                endMinuteSelect.value = displayEndMinute;
                console.log('종료시간 설정 (30분 추가):', displayEndHour + ':' + displayEndMinute);
            }
            
            // 예약일 설정 (클릭한 셀의 실제 날짜)
            const reservationDateInput = document.getElementById('reservationDate');
            if (reservationDateInput && targetDay) {
                // targetDay가 주어졌으면 해당 요일의 날짜 계산
                const currentWeek = getCurrentWeek();
                const targetDate = new Date(currentWeek[targetDay - 1]);
                reservationDateInput.value = targetDate.toISOString().split('T')[0];
                console.log('예약일 설정:', targetDate.toISOString().split('T')[0], '요일:', targetDay);
            } else if (reservationDateInput) {
                // targetDay가 없으면 오늘 날짜로 설정
                const today = new Date();
                reservationDateInput.value = today.toISOString().split('T')[0];
                console.log('예약일 설정 (오늘):', today.toISOString().split('T')[0]);
            }
            
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            
            // 회원 선택 이벤트 설정
            setupMemberSelectEvent();
            
            // 교육 메모 기능 초기화
            setupEducationMemoFeature();
            
            // 시험 일정 필드 이벤트 초기화
            setupTestScheduleFields();
            
            // 계속 예약을 위한 회원 정보가 있으면 미리 입력
            if (lastReservationMember) {
                console.log('계속 예약을 위한 회원 정보 로드:', lastReservationMember);
                
                // 회원 이름 입력
                const memberSearchInput = document.getElementById('memberSearchInput');
                const selectedMemberId = document.getElementById('selectedMemberId');
                if (memberSearchInput) {
                    memberSearchInput.value = lastReservationMember.memberName;
                }
                if (selectedMemberId) {
                    selectedMemberId.value = lastReservationMember.memberId;
                }
                
                // 회원 타입 설정
                const memberTypeRadio = document.querySelector(`input[name="memberType"][value="${lastReservationMember.memberType}"]`);
                if (memberTypeRadio) {
                    memberTypeRadio.checked = true;
                    handleMemberTypeChange(lastReservationMember.memberType, true); // preserveValues = true
                }
                
                // 일정 유형 설정
                const scheduleTypeRadio = document.querySelector(`input[name="scheduleType"][value="${lastReservationMember.scheduleType}"]`);
                if (scheduleTypeRadio) {
                    scheduleTypeRadio.checked = true;
                }
                
                // 연락처 입력
                const contactInput = document.getElementById('contactInput');
                if (contactInput) {
                    contactInput.value = lastReservationMember.contactPhone;
                }
                
                // 회원 상세 정보 로드 (교육 메모는 데이터베이스에서 자동으로 로드됨)
                if (lastReservationMember.memberId && lastReservationMember.memberType === 'existing') {
                    loadMemberDetail(lastReservationMember.memberId);
                }
            }
            
            // 버튼 마진 적용 (강제)
            setTimeout(() => {
                const normalModeButtons = document.getElementById('normalModeButtons');
                const editModeButtons = document.getElementById('editModeButtons');
                const buttonContainer = document.querySelector('div[style*="display: flex"][style*="gap: 15px"][style*="justify-content: flex-end"]');
                
                if (normalModeButtons) {
                    normalModeButtons.style.margin = '0 20px !important';
                }
                if (editModeButtons) {
                    editModeButtons.style.margin = '0 20px !important';
                }
                if (buttonContainer) {
                    buttonContainer.style.marginLeft = '20px';
                    buttonContainer.style.marginRight = '20px';
                }
            }, 100);
            
            // currentReservationData 설정 (actualDate 포함)
            const currentWeek = getCurrentWeek();
            let actualDate = null;
            
            if (targetDay && targetDay >= 1 && targetDay <= 7) {
                const dateObj = currentWeek[targetDay - 1];
                console.log('dateObj:', dateObj);
                console.log('dateObj 타입:', typeof dateObj);
                
                if (dateObj instanceof Date) {
                    // Date 객체를 YYYY-MM-DD 형식으로 변환
                    actualDate = dateObj.toISOString().split('T')[0];
                    console.log('변환된 actualDate:', actualDate);
                } else {
                    console.error('dateObj가 Date 객체가 아닙니다:', dateObj);
                }
            } else {
                console.log('targetDay가 유효하지 않습니다:', targetDay);
            }
            
            currentReservationData = {
                actualDate: actualDate,
                targetDay: targetDay,
                startTime: startTime,
                endTime: endTime
            };
            
            console.log('currentReservationData 설정:', currentReservationData);
            console.log('모달 표시됨');
        }
        
        function closeModal() {
            const modal = document.getElementById('reservationModal');
            modal.style.display = 'none';
            
            // 현재 수정 중인 예약 데이터 초기화
            currentReservationData = null;
            
            // 일반 모드로 되돌리기
            document.getElementById('editModeButtons').style.display = 'none';
            const normalModeButtons = document.getElementById('normalModeButtons');
            normalModeButtons.style.display = 'flex';
            normalModeButtons.style.margin = '0 20px';
            
            // 폼 초기화
            const memberSearchInput = document.getElementById('memberSearchInput');
            const selectedMemberId = document.getElementById('selectedMemberId');
            if (memberSearchInput) memberSearchInput.value = '';
            if (selectedMemberId) selectedMemberId.value = '';
            document.getElementById('contactInput').value = '';
            document.getElementById('productInput').value = '';
            document.getElementById('reservationMemo').value = '';
            
            // 교육 및 메모사항 초기화
            clearEducationMemos();
            
            // 시험 일정 초기화
            document.getElementById('functionTestDate').value = '';
            document.getElementById('roadTestDate').value = '';
            
            // 회원 상세 정보 숨기기
            hideMemberDetail();
            
            console.log('모달 닫힘');
        }
        
        // 예약 수정 모달 열기 함수 (기존 모달 재사용)
        function openReservationEditModal(reservationData) {
            console.log('예약 수정 모달 열기:', reservationData);
            
            // actualDate가 없으면 targetDay로 계산
            if (!reservationData.actualDate && reservationData.targetDay !== undefined) {
                const currentWeek = getCurrentWeek();
                const calculatedDate = new Date(currentWeek[reservationData.targetDay]);
                reservationData.actualDate = calculatedDate.toISOString().split('T')[0];
                console.log('🔧 actualDate 계산됨:', {
                    targetDay: reservationData.targetDay,
                    calculatedDate: reservationData.actualDate,
                    요일: ['월', '화', '수', '목', '금', '토', '일'][reservationData.targetDay]
                });
            }
            
            // 현재 수정 중인 예약 데이터 저장
            currentReservationData = reservationData;
            
            // actualDate를 currentReservationData에 명시적으로 저장
            if (reservationData.actualDate) {
                currentReservationData.actualDate = reservationData.actualDate;
            }
            
            // actualDate가 있으면 로그 출력
            if (reservationData.actualDate) {
            } else {
            }
            
            const modal = document.getElementById('reservationModal');
            
            // 폼 데이터 채우기
            const memberSearchInput = document.getElementById('memberSearchInput');
            const selectedMemberId = document.getElementById('selectedMemberId');
            
            // 비회원인지 확인 (scheduleType이 'no-product'이거나 memberType이 'quick'이거나 memberId가 없는 경우)
            const isNonMember = reservationData.scheduleType === 'no-product' || reservationData.memberType === 'quick' || !reservationData.memberId;
            
            if (!isNonMember && reservationData.memberId) {
                // 회원 ID로 회원 정보 찾기
                const member = allMembers.find(m => m.id == reservationData.memberId);
                if (member) {
                    memberSearchInput.value = member.name;
                    selectedMemberId.value = member.id;
                    // 연락처 자동 입력
                    const contactInput = document.getElementById('contactInput');
                    if (contactInput) {
                        contactInput.value = member.phone || '';
                    }
                } else {
                    memberSearchInput.value = '';
                    selectedMemberId.value = '';
                }
            } else {
                // 비회원인 경우
                
                memberSearchInput.value = reservationData.memberName || '';
                selectedMemberId.value = '';
                
                // 연락처 필드에 저장된 연락처 정보 표시
                const contactInput = document.getElementById('contactInput');
                if (contactInput) {
                    contactInput.value = reservationData.contactPhone || '';
                }
                
            }
            // 회원 유형 설정 (필드 값 설정 후에 호출)
            let memberType = reservationData.memberType;
            if (isNonMember) {
                memberType = 'quick'; // 비회원인 경우 강제로 'quick' 설정
            }
            
            const memberTypeRadio = document.querySelector(`input[name="memberType"][value="${memberType}"]`);
            if (memberTypeRadio) {
                memberTypeRadio.checked = true;
                
                // 비회원인 경우에만 플레이스홀더 설정
                if (isNonMember) {
                    const searchInput = document.getElementById('memberSearchInput');
                    if (searchInput) {
                        searchInput.placeholder = '회원 이름을 작성해주세요';
                    }
                }
            }
            document.getElementById('startHour').value = reservationData.startHour;
            document.getElementById('startMinute').value = reservationData.startMinute;
            document.getElementById('endHour').value = reservationData.endHour;
            document.getElementById('endMinute').value = reservationData.endMinute;
            // 일정 유형 설정
            let scheduleTypeValue = reservationData.scheduleType;
            if (scheduleTypeValue === 'no-product') {
                scheduleTypeValue = 'quick'; // 비회원인 경우 'quick'로 변환
            }
            
            const scheduleTypeRadio = document.querySelector(`input[name="scheduleType"][value="${scheduleTypeValue}"]`);
            if (scheduleTypeRadio) {
                scheduleTypeRadio.checked = true;
            } else {
                console.warn('일정 유형 라디오 버튼을 찾을 수 없습니다:', scheduleTypeValue);
            }
            
            // 예약 메모 로드 (빈 값이나 "0"인 경우 처리)
            const reservationMemo = reservationData.reservationMemo;
            if (reservationMemo && reservationMemo !== '0' && reservationMemo.trim() !== '') {
                document.getElementById('reservationMemo').value = reservationMemo;
            } else {
                document.getElementById('reservationMemo').value = '';
            }
            
            // 교육 메모 로드
            if (reservationData.educationMemos) {
                loadEducationMemos(reservationData.educationMemos);
            }
            
            // 시험 일정 로드
            if (reservationData.functionTestDate) {
                const functionTestDate = document.getElementById('functionTestDate');
                if (functionTestDate) {
                    functionTestDate.value = reservationData.functionTestDate;
                    functionTestDate.style.background = '#fff';
                    functionTestDate.style.color = '#333';
                }
            }
            if (reservationData.roadTestDate) {
                const roadTestDate = document.getElementById('roadTestDate');
                if (roadTestDate) {
                    roadTestDate.value = reservationData.roadTestDate;
                    roadTestDate.style.background = '#fff';
                    roadTestDate.style.color = '#333';
                }
            }
            
            // 회원이 선택된 경우 연락처와 시험 일정 로드
            if (!isNonMember && reservationData.memberId) {
                loadMemberDetail(reservationData.memberId);
                
                // 연락처 필드에 회원의 전화번호 설정
                const contactInput = document.getElementById('contactInput');
                if (contactInput) {
                    // 회원 상세 정보에서 전화번호 가져오기
                    fetch(`api/debug_member_detail.php?id=${reservationData.memberId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success && result.member.phone) {
                                contactInput.value = result.member.phone;
                            }
                        })
                        .catch(error => {
                            console.error('연락처 로드 오류:', error);
                        });
                }
            } else {
                // 비회원인 경우 회원 상세 정보 숨기기
                hideMemberDetail();
            }
            
            // 모달에 예약 데이터 저장 (나중에 사용) - reservationId 포함
            const fullReservationData = {
                ...reservationData,
                reservationId: reservationData.reservationId
            };
            modal.setAttribute('data-reservation', JSON.stringify(fullReservationData));
            console.log('모달에 저장된 예약 데이터:', fullReservationData);
            
            // 수정 모드로 전환
            document.getElementById('editModeButtons').style.display = 'flex';
            document.getElementById('normalModeButtons').style.display = 'none';
            
            // 수정 모드 버튼 이벤트 리스너 추가
            setupEditModeButtons();
            
            // 회원 선택 이벤트 설정
            setupMemberSelectEvent();
            
            // 교육 메모 기능 초기화
            setupEducationMemoFeature();
            
            // 시험 일정 필드 이벤트 초기화
            setupTestScheduleFields();
            
            // 비회원인 경우 연락처 필드 다시 설정 (다른 코드가 덮어쓸 수 있으므로)
            if (isNonMember) {
                const contactInput = document.getElementById('contactInput');
                if (contactInput && reservationData.contactPhone) {
                    contactInput.value = reservationData.contactPhone;
                }
            }
            
            // 모달 표시
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 999999 !important;
                padding: 20px !important;
                box-sizing: border-box !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            console.log('예약 수정 모달 표시됨');
        }
        
        // 예약 삭제 함수
        function deleteReservation() {
            console.log('deleteReservation 함수 호출됨');
            
            if (confirm('정말로 이 예약을 삭제하시겠습니까?')) {
                const modal = document.getElementById('reservationModal');
                console.log('모달 찾음:', modal);
                
                const reservationDataStr = modal.getAttribute('data-reservation');
                console.log('예약 데이터 문자열:', reservationDataStr);
                
                let reservationData = null;
                
                if (reservationDataStr) {
                    reservationData = JSON.parse(reservationDataStr);
                    console.log('예약 데이터 파싱됨:', reservationData);
                    
                    // 예약 블록 제거 - 강화된 방법
                    let blockRemoved = false;
                    
                    // 방법 1: blockElement가 있으면 직접 제거
                    if (reservationData.blockElement && typeof reservationData.blockElement.remove === 'function') {
                        reservationData.blockElement.remove();
                        blockRemoved = true;
                    }
                    
                    // 방법 2: blockElement가 없거나 제거 실패 시 위치로 찾아서 제거
                    if (!blockRemoved) {
                        const targetDay = reservationData.targetDay || 1;
                        const targetSeat = reservationData.targetSeat || 1;
                        const startTimeIndex = getTimeIndex(parseInt(reservationData.startHour), parseInt(reservationData.startMinute));
                        
                        console.log('블록 재검색:', { targetDay, targetSeat, startTimeIndex });
                        
                        const targetSlot = document.querySelector(`[data-time-index="${startTimeIndex}"][data-day="${targetDay}"][data-seat="${targetSeat}"]`);
                        if (targetSlot) {
                            const existingBlock = targetSlot.querySelector('.reservation-block');
                            if (existingBlock) {
                                existingBlock.remove();
                                blockRemoved = true;
                            } else {
                            }
                        } else {
                        }
                    }
                    
                    // 방법 3: 모든 예약 블록 중에서 해당 reservationId 찾아서 제거
                    if (!blockRemoved) {
                        const reservationId = reservationData.reservationId;
                        const allBlocks = document.querySelectorAll('.reservation-block');
                        console.log('모든 예약 블록 검색 중:', allBlocks.length, '개');
                        
                        for (let block of allBlocks) {
                            const blockReservationId = block.getAttribute('data-reservation-id');
                            if (blockReservationId === reservationId.toString()) {
                                block.remove();
                                blockRemoved = true;
                                break;
                            }
                        }
                        
                        if (!blockRemoved) {
                        }
                    }
                } else {
                }
                
                // 서버에서도 삭제
                if (reservationData && reservationData.reservationId) {
                    const reservationId = reservationData.reservationId;
                    
                    deleteReservationFromServer(reservationId)
                    .then(result => {
                        closeModal();
                        alert('예약이 삭제되었습니다.');
                    })
                    .catch(error => {
                        
                        // 서버 삭제가 실패해도 화면에서는 제거
                        closeModal();
                        alert('예약이 삭제되었습니다. (서버 동기화 실패)');
                    });
                } else {
                    closeModal();
                    alert('예약 ID가 없어서 서버에서 삭제할 수 없습니다.');
                }
            }
        }
        
        // 결석 처리 함수
        function markAbsent() {
            console.log('결석 처리 시작');
            
            if (!currentReservationData) {
                alert('예약 정보를 찾을 수 없습니다.');
                return;
            }
            
            if (confirm('이 예약을 결석으로 처리하시겠습니까?')) {
                // 결석 처리할 때 현재 예약 블록의 위치 정보 가져오기
                const blockElement = currentReservationData.blockElement;
                let targetDay = currentReservationData.targetDay;
                let targetSeat = currentReservationData.targetSeat;
                
                // blockElement에서 직접 위치 정보 가져오기
                if (blockElement) {
                    const parentSlot = blockElement.closest('.reservation-slot');
                    if (parentSlot) {
                        targetDay = parseInt(parentSlot.getAttribute('data-day')) || targetDay;
                        targetSeat = parseInt(parentSlot.getAttribute('data-seat')) || targetSeat;
                        console.log('결석 처리 - 블록에서 위치 정보 가져옴:', { targetDay, targetSeat });
                    }
                }
                
                console.log('결석 처리 - 최종 위치 정보:', { 
                    originalTargetDay: currentReservationData.targetDay,
                    originalTargetSeat: currentReservationData.targetSeat,
                    finalTargetDay: targetDay,
                    finalTargetSeat: targetSeat
                });
                
                // 서버에서 예약을 결석 처리로 업데이트 (회원 이름과 위치 정보 유지)
                updateReservationOnServer(currentReservationData.reservationId, {
                    ...currentReservationData,
                    scheduleType: 'absent',
                    targetDay: targetDay,
                    targetSeat: targetSeat
                }).then(() => {
                    // 예약 블록을 결석 색상으로 변경
                    if (currentReservationData.blockElement) {
                        // 기존 색상 클래스 제거
                        currentReservationData.blockElement.classList.remove('custom', 'time', 'none', 'unlimited', 'course');
                        // 결석 클래스 추가
                        currentReservationData.blockElement.classList.add('absent');
                        currentReservationData.blockElement.className = 'reservation-block absent';
                        // 결석 처리 시에도 회원 이름만 표시
                        currentReservationData.blockElement.textContent = currentReservationData.memberName || '결석';
                    }
                    
                    closeModal();
                    console.log('결석 처리됨:', currentReservationData);
                    alert('결석으로 처리되었습니다.');
                }).catch(error => {
                    console.error('결석 처리 실패:', error);
                    alert('결석 처리 중 오류가 발생했습니다: ' + error.message);
                });
            }
        }
        
        // 예약 수정 함수
        function updateReservation() {
            const modal = document.getElementById('reservationModal');
            const reservationData = currentReservationData || JSON.parse(modal.getAttribute('data-reservation'));
            
            // 수정된 데이터 수집
            const memberSearchInput = document.getElementById('memberSearchInput');
            const selectedMemberId = document.getElementById('selectedMemberId');
            
            const updatedData = {
                memberName: memberSearchInput ? memberSearchInput.value : '새 예약',
                memberId: selectedMemberId ? selectedMemberId.value : null,
                memberType: document.querySelector('input[name="memberType"]:checked').value,
                startHour: document.getElementById('startHour').value,
                startMinute: document.getElementById('startMinute').value,
                endHour: document.getElementById('endHour').value,
                endMinute: document.getElementById('endMinute').value,
                scheduleType: document.querySelector('input[name="scheduleType"]:checked').value,
                contactPhone: document.getElementById('contactInput') ? document.getElementById('contactInput').value : '',
                reservationMemo: document.getElementById('reservationMemo').value,
                educationMemos: getEducationMemos(),
                functionTestDate: document.getElementById('functionTestDate').value,
                roadTestDate: document.getElementById('roadTestDate').value,
                targetDay: reservationData.targetDay,
                targetSeat: reservationData.targetSeat,
                productName: reservationData.productName,
                productHours: reservationData.productHours
            };
            
            console.log('예약 수정됨:', updatedData);
            
            // 서버에 예약 수정 요청
            if (reservationData.reservationId) {
                updateReservationOnServer(reservationData.reservationId, updatedData)
                .then(result => {
                    console.log('서버 예약 수정 성공:', result);
                    alert('예약이 수정되었습니다.');
                    closeModal();
                })
                .catch(error => {
                    console.error('서버 예약 수정 실패:', error);
                    alert('예약 수정 중 오류가 발생했습니다: ' + error.message);
                });
            } else {
                console.warn('예약 ID가 없어서 서버 업데이트를 건너뜁니다.');
            }
            
            // 예약 블록 업데이트
            let blockElement = reservationData.blockElement;
            
            // blockElement가 DOM 요소가 아닌 경우 찾기
            if (!blockElement || !blockElement.setAttribute) {
                // 예약 블록을 다시 찾기
                const allBlocks = document.querySelectorAll('.reservation-block');
                for (let block of allBlocks) {
                    if (block.getAttribute('data-reservation-id') == reservationData.reservationId) {
                        blockElement = block;
                        break;
                    }
                }
            }
            
            if (blockElement && blockElement.setAttribute) {
                // 이름만 표시
                blockElement.textContent = updatedData.memberName;
                
                // 회원 ID 업데이트
                if (updatedData.memberId) {
                    blockElement.setAttribute('data-member-id', updatedData.memberId);
                } else {
                    blockElement.removeAttribute('data-member-id');
                }
                
                // 예약 메모 업데이트
                if (updatedData.reservationMemo) {
                    blockElement.setAttribute('data-reservation-memo', updatedData.reservationMemo);
                } else {
                    blockElement.removeAttribute('data-reservation-memo');
                }
                
                // 교육 메모 업데이트
                if (updatedData.educationMemos && updatedData.educationMemos.length > 0) {
                    blockElement.setAttribute('data-education-memos', JSON.stringify(updatedData.educationMemos));
                } else {
                    blockElement.removeAttribute('data-education-memos');
                }
                
                // 시험 일정 업데이트
                if (updatedData.functionTestDate) {
                    blockElement.setAttribute('data-function-test-date', updatedData.functionTestDate);
                } else {
                    blockElement.removeAttribute('data-function-test-date');
                }
                
                if (updatedData.roadTestDate) {
                    blockElement.setAttribute('data-road-test-date', updatedData.roadTestDate);
                } else {
                    blockElement.removeAttribute('data-road-test-date');
                }
                
                // 색상 업데이트
                const scheduleType = updatedData.scheduleType;
                const productName = updatedData.productName;
                const productHours = updatedData.productHours;
                
                
                const newColorClass = determineColorClass(scheduleType, productName, productHours);
                
                // 기존 색상 클래스 제거
                blockElement.classList.remove('custom', 'time', 'none', 'unlimited', 'course', 'absent');
                // 새로운 색상 클래스 추가
                blockElement.classList.add(newColorClass);
                blockElement.className = `reservation-block ${newColorClass}`;
                
                // 인라인 background 스타일 제거 (CSS 클래스가 우선되도록)
                blockElement.style.removeProperty('background');
                blockElement.style.removeProperty('background-color');
                
            }
            
            closeModal();
            alert('예약이 수정되었습니다.');
        }
        
        // 예약 시간 계산 함수
        function calculateReservationHours(startHour, startMinute, endHour, endMinute) {
            const startTime = parseInt(startHour) * 60 + parseInt(startMinute);
            const endTime = parseInt(endHour) * 60 + parseInt(endMinute);
            const durationMinutes = endTime - startTime;
            return Math.max(0, durationMinutes / 60); // 시간 단위로 반환
        }

        async function saveReservation(buttonType = 'immediate') {
            console.log('예약 저장');
            
            // 폼 데이터 수집
            const searchInput = document.getElementById('memberSearchInput');
            const selectedMemberId = document.getElementById('selectedMemberId');
            let memberName = '새 예약';
            let memberId = null;
            
            if (searchInput && selectedMemberId) {
                memberName = searchInput.value || '새 예약';
                memberId = selectedMemberId.value || null;
            }
            const memberType = document.querySelector('input[name="memberType"]:checked')?.value || 'existing';
            let scheduleType = document.querySelector('input[name="scheduleType"]:checked')?.value || 'course';
            
            // 비회원일 때는 scheduleType을 'no-product'로 설정
            if (memberType === 'quick') {
                scheduleType = 'no-product';
            }
            const startHour = document.getElementById('startHour')?.value || '09';
            const startMinute = document.getElementById('startMinute')?.value || '00';
            const endHour = document.getElementById('endHour')?.value || '10';
            const endMinute = document.getElementById('endMinute')?.value || '00';
            const reservationMemo = document.getElementById('reservationMemo')?.value || '';
            const educationMemos = getEducationMemos();
            const functionTestDate = document.getElementById('functionTestDate')?.value || '';
            const roadTestDate = document.getElementById('roadTestDate')?.value || '';
            const productName = document.getElementById('productInput')?.value || '';
            const contactPhone = document.getElementById('contactInput')?.value || '';
            
            // 회원의 product_hours 가져오기
            let productHours = 0;
            if (memberType === 'quick') {
                // 비회원일 때는 productHours를 0으로 설정
                productHours = 0;
                console.log('비회원: product_hours를 0으로 설정');
            } else if (memberId) {
                // 회원인 경우 서버에서 최신 정보 가져오기
                try {
                    const memberResponse = await fetch(`api/debug_member_detail.php?id=${memberId}`);
                    const memberResult = await memberResponse.json();
                    if (memberResult.success && memberResult.member) {
                        productHours = memberResult.member.product_hours || 0;
                        console.log('서버에서 가져온 회원의 product_hours:', productHours);
                    } else {
                        console.warn('회원 정보를 가져올 수 없음, 기본값 0 사용');
                        productHours = 0;
                    }
                } catch (error) {
                    console.error('회원 정보 가져오기 실패:', error);
                    productHours = 0;
                }
            }
            
            // 예약 시간 계산
            const reservationHours = calculateReservationHours(startHour, startMinute, endHour, endMinute);
            
            // 예약 데이터를 서버에 저장
            // 드래그한 좌석 정보 가져오기
            const targetSeat = reservationInfo.seat || 1;
            const targetDay = reservationInfo.day || dragState.startDay || 1;
            
            console.log('예약 저장할 위치 정보:', { 
                targetDay, 
                targetSeat,
                reservationInfo: reservationInfo,
                dragState: dragState,
                최종사용값: { targetDay, targetSeat }
            });
            
            // 예약일 필드에서 값 가져오기
            const reservationDateInput = document.getElementById('reservationDate');
            const reservationDate = reservationDateInput ? reservationDateInput.value : null;
            
            console.log('예약일 필드 값:', reservationDate);
            console.log('currentReservationData 확인:', currentReservationData);
            
            try {
                const reservationId = await saveReservationToServer({
                    memberId: memberId,
                    memberName: memberName,
                    memberType: memberType,
                    scheduleType: scheduleType,
                    startHour: startHour,
                    startMinute: startMinute,
                    endHour: endHour,
                    endMinute: endMinute,
                    reservationHours: reservationHours, // 예약 시간 추가
                    targetDay: targetDay,
                    targetSeat: targetSeat,
                    reservationDate: reservationDate, // 예약 날짜 추가
                    reservationMemo: reservationMemo,
                    educationMemos: educationMemos,
                    functionTestDate: functionTestDate,
                    roadTestDate: roadTestDate,
                    productName: productName,
                    productHours: productHours,
                    contactPhone: contactPhone // 연락처 정보 추가
                });
                
                // 예약 블록 생성 (서버 ID 포함) - 올바른 위치로
                console.log('createReservationBlock 호출 시 전달되는 위치:', { targetDay, targetSeat });
                createReservationBlock(memberName, memberId, memberType, scheduleType, startHour, startMinute, endHour, endMinute, reservationMemo, educationMemos, functionTestDate, roadTestDate, reservationId, targetDay, targetSeat, productName, productHours, contactPhone);
                
                // 계속 예약을 위한 회원 정보 저장 (기본 정보만)
                if (buttonType === 'continue') {
                    lastReservationMember = {
                        memberName: memberName,
                        memberId: memberId,
                        memberType: memberType,
                        scheduleType: scheduleType,
                        contactPhone: contactPhone,
                        productName: productName,
                        productHours: productHours
                    };
                    console.log('계속 예약을 위한 회원 정보 저장:', lastReservationMember);
                } else {
                    // 바로 예약인 경우 회원 정보 초기화
                    lastReservationMember = null;
                }
                
                // 교육 메모는 save_reservation.php에서 자동으로 회원 테이블에 저장됩니다
                
                alert('예약이 등록되었습니다.');
                closeModal();
            } catch (error) {
                console.error('예약 저장 실패:', error);
                alert('예약 저장 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 실제 예약 블록 생성 함수
        function createReservationBlock(memberName, memberId, memberType, scheduleType, startHour, startMinute, endHour, endMinute, reservationMemo, educationMemos, functionTestDate, roadTestDate, reservationId = null, targetDay = null, targetSeat = null, productName = null, productHours = 0, contactPhone = '') {
            console.log('예약 블록 생성 시작:', {
                memberName, memberType, scheduleType, 
                startHour, startMinute, endHour, endMinute,
                전달받은targetDay: targetDay,
                전달받은targetSeat: targetSeat,
                dragState: dragState
            });
            
            // 시간 값이 유효하지 않은 경우 기본값 설정
            if (!startHour || startHour === '' || startHour === 'null' || startHour === null) {
                console.warn('startHour가 유효하지 않음, 기본값 9로 설정:', startHour);
                startHour = '9';
            }
            if (!startMinute || startMinute === '' || startMinute === 'null' || startMinute === null) {
                console.warn('startMinute가 유효하지 않음, 기본값 0으로 설정:', startMinute);
                startMinute = '0';
            }
            if (!endHour || endHour === '' || endHour === 'null' || endHour === null) {
                console.warn('endHour가 유효하지 않음, 기본값 10으로 설정:', endHour);
                endHour = '10';
            }
            if (!endMinute || endMinute === '' || endMinute === 'null' || endMinute === null) {
                console.warn('endMinute가 유효하지 않음, 기본값 0으로 설정:', endMinute);
                endMinute = '0';
            }
            
            // 시간을 인덱스로 변환 (30분 추가하지 않음)
            const startTimeIndex = getTimeIndex(startHour, startMinute);
            const endTimeIndex = getTimeIndex(endHour, endMinute);
            
            console.log('시간 인덱스:', { startTimeIndex, endTimeIndex });
            
            if (startTimeIndex === -1 || endTimeIndex === -1) {
                console.error('잘못된 시간 형식:', {
                    startHour, startMinute, endHour, endMinute,
                    startTimeIndex, endTimeIndex
                });
                alert('시간 형식이 올바르지 않습니다. 다시 시도해주세요.');
                return;
            }
            
            // 실제 날짜 계산 (targetDay를 사용하여 현재 주의 해당 요일 날짜 계산)
            let actualDate = null;
            if (targetDay !== null && targetDay !== undefined) {
                const currentWeek = getCurrentWeek();
                // targetDay는 1-7이지만 배열 인덱스는 0-6이므로 1을 빼야 함
                const dayIndex = targetDay - 1;
                actualDate = new Date(currentWeek[dayIndex]);
                console.log('🔍 실제 날짜 계산:', {
                    targetDay: targetDay,
                    dayIndex: dayIndex,
                    currentWeek: currentWeek.map(d => d.toISOString().split('T')[0]),
                    selectedDate: currentWeek[dayIndex],
                    actualDate: actualDate,
                    dateString: actualDate.toISOString().split('T')[0],
                    요일: ['월', '화', '수', '목', '금', '토', '일'][dayIndex],
                    currentWeekStart: currentWeekStart ? currentWeekStart.toISOString().split('T')[0] : 'null'
                });
            } else {
            }

            // 색상 클래스 결정
            const colorClass = determineColorClass(scheduleType, productName, productHours);
            
            // 예약 블록 생성
            const block = document.createElement('div');
            block.className = `reservation-block ${colorClass}`;
            block.style.position = 'absolute';
            block.style.left = '2px';
            block.style.right = '2px';
            block.style.top = '0px';
            block.style.height = ((endTimeIndex - startTimeIndex) * 60) + 'px';
            block.style.zIndex = '10';
            block.style.width = 'calc(100% - 4px)'; // left + right = 4px
            block.style.boxSizing = 'border-box';
            // background는 CSS 클래스에서 처리하므로 인라인 스타일로 설정하지 않음
            // 이름만 표시
            block.textContent = memberName;
            block.style.color = 'white';
            block.style.fontSize = '11px';
            block.style.display = 'flex';
            block.style.alignItems = 'center';
            block.style.justifyContent = 'center';
            block.style.borderRadius = '4px';
            block.style.padding = '2px 4px';
            block.style.minHeight = '28px';
            
            // 서버 ID 저장
            if (reservationId) {
                block.setAttribute('data-reservation-id', reservationId);
            }
            
            // 회원 ID 저장
            if (memberId) {
                block.setAttribute('data-member-id', memberId);
            }
            
            // 연락처 저장
            if (contactPhone) {
                block.setAttribute('data-contact-phone', contactPhone);
            }
            
            // 실제 날짜 저장
            if (actualDate) {
                block.setAttribute('data-actual-date', actualDate.toISOString().split('T')[0]);
                console.log('블록에 실제 날짜 저장:', actualDate.toISOString().split('T')[0]);
            }
            
            // 예약 메모 저장
            if (reservationMemo) {
                block.setAttribute('data-reservation-memo', reservationMemo);
            }
            
            // 교육 메모 저장
            if (educationMemos && educationMemos.length > 0) {
                block.setAttribute('data-education-memos', JSON.stringify(educationMemos));
            }
            
            // 시험 일정 저장
            if (functionTestDate) {
                block.setAttribute('data-function-test-date', functionTestDate);
            }
            if (roadTestDate) {
                block.setAttribute('data-road-test-date', roadTestDate);
            }
            
            // 시간 차감을 위한 데이터 속성 저장
            block.setAttribute('data-member-type', memberType);
            block.setAttribute('data-schedule-type', scheduleType);
            block.setAttribute('data-product-hours', productHours);
            block.setAttribute('data-start-hour', startHour);
            block.setAttribute('data-start-minute', startMinute);
            block.setAttribute('data-end-hour', endHour);
            block.setAttribute('data-end-minute', endMinute);
            block.setAttribute('data-target-day', targetDay);
            
            // 드래그한 요일과 좌석에 추가
            console.log('🔍 reservationInfo 확인:', reservationInfo);
            console.log('🔍 dragState 확인:', dragState);
            console.log('🔍 전달받은 targetDay, targetSeat:', { targetDay, targetSeat });
            
            // 새로고침 시에는 전달받은 값 사용, 드래그 시에는 reservationInfo 사용
            let finalTargetDay, finalTargetSeat;
            
            if (reservationInfo && reservationInfo.day && reservationInfo.seat) {
                // 드래그로 생성된 경우: reservationInfo 사용
                finalTargetDay = reservationInfo.day;
                finalTargetSeat = reservationInfo.seat;
                console.log('🔧 드래그로 생성: reservationInfo 값 사용:', {
                    reservationInfoDay: reservationInfo.day,
                    reservationInfoSeat: reservationInfo.seat,
                    최종targetDay: finalTargetDay,
                    최종targetSeat: finalTargetSeat
                });
            } else {
                // 새로고침으로 로드된 경우: 전달받은 값 사용
                finalTargetDay = targetDay || 1;
                finalTargetSeat = targetSeat || 1;
                console.log('🔧 새로고침으로 로드: 전달받은 값 사용:', {
                    전달받은targetDay: targetDay,
                    전달받은targetSeat: targetSeat,
                    최종targetDay: finalTargetDay,
                    최종targetSeat: finalTargetSeat
                });
            }
            
            // 최종 값 유효성 검사
            if (finalTargetDay < 1 || finalTargetDay > 7) {
                console.warn('잘못된 finalTargetDay 값:', finalTargetDay, '기본값 1로 설정');
                finalTargetDay = 1;
            }
            if (finalTargetSeat < 1 || finalTargetSeat > 6) {
                console.warn('잘못된 finalTargetSeat 값:', finalTargetSeat, '기본값 1로 설정');
                finalTargetSeat = 1;
            }
            
            console.log('최종 위치 계산:', {
                전달받은targetDay: targetDay,
                전달받은targetSeat: targetSeat,
                reservationInfoDay: reservationInfo.day,
                reservationInfoSeat: reservationInfo.seat,
                최종targetDay: finalTargetDay,
                최종targetSeat: finalTargetSeat
            });
            
            console.log('🔧 최종 targetDay, targetSeat:', { finalTargetDay, finalTargetSeat });
            
            console.log('🔍 예약 블록 생성 정보:', {
                startTimeIndex, endTimeIndex, finalTargetDay, finalTargetSeat,
                dragState: dragState,
                timeSlots: timeSlots.slice(0, 5) // 처음 5개만 표시
            });
            
            const targetSlot = document.querySelector(`[data-time-index="${startTimeIndex}"][data-day="${finalTargetDay}"][data-seat="${finalTargetSeat}"]`);
            console.log('🔍 대상 슬롯 찾기:', {
                selector: `[data-time-index="${startTimeIndex}"][data-day="${finalTargetDay}"][data-seat="${finalTargetSeat}"]`,
                startTimeIndex, finalTargetDay, finalTargetSeat,
                found: !!targetSlot,
                targetSlot: targetSlot
            });
            
            // 만약 슬롯을 찾지 못했다면 다른 방법으로 찾기
            if (!targetSlot) {
                const alternativeSlot = document.querySelector(`[data-time-index="${startTimeIndex}"][data-day="${finalTargetDay}"][data-seat="${finalTargetSeat}"]`);
                if (alternativeSlot) {
                }
            }
            
            // 모든 가능한 슬롯 확인
            const allSlots = document.querySelectorAll(`[data-time-index="${startTimeIndex}"]`);
            
            // 슬롯이 없으면 생성하지 않음
            if (allSlots.length === 0) {
                return;
            }
            
            // 최종 슬롯 결정 - reservationInfo 우선 사용
            let finalSlot = document.querySelector(`[data-time-index="${startTimeIndex}"][data-day="${finalTargetDay}"][data-seat="${finalTargetSeat}"]`);
            
            // 헤더 영역인지 확인
            if (startTimeIndex === -1 || !finalSlot || finalSlot.closest('.calendar-header')) {
                
                // 다른 위치에서 슬롯 찾기 시도 (헤더가 아닌 첫 번째 슬롯)
                const alternativeSlots = document.querySelectorAll(`[data-time-index="${startTimeIndex}"]`);
                let validSlot = null;
                
                for (let slot of alternativeSlots) {
                    if (!slot.closest('.calendar-header') && slot.classList.contains('reservation-slot')) {
                        validSlot = slot;
                        break;
                    }
                }
                
                if (validSlot) {
                    console.log('대체 슬롯 발견, 해당 위치에 생성:', validSlot);
                    validSlot.appendChild(block);
                    return;
                } else {
                    console.error('적절한 슬롯을 찾을 수 없습니다.');
                    return;
                }
            }
            
            // 시간 슬롯이 아닌 경우도 차단
            if (!finalSlot.classList.contains('reservation-slot')) {
                console.error('시간 슬롯이 아닌 영역에는 예약 블록을 생성할 수 없습니다.');
                return;
            }
            
            if (finalSlot) {
                // 기존 예약 블록 제거 (더 안전하게)
                const existingBlocks = finalSlot.querySelectorAll('.reservation-block');
                existingBlocks.forEach(existingBlock => {
                    if (existingBlock.parentNode) {
                        existingBlock.parentNode.removeChild(existingBlock);
                    }
                });
                
                // 중복 방지: 같은 시간대에 같은 회원의 예약이 있는지 확인
                const conflictingBlocks = document.querySelectorAll(`[data-time-index="${startTimeIndex}"][data-day="${finalTargetDay}"] .reservation-block`);
                if (conflictingBlocks.length > 0) {
                    // 같은 회원의 예약만 제거
                    const sameMemberBlocks = Array.from(conflictingBlocks).filter(block => 
                        block.getAttribute('data-member-id') === memberId
                    );
                    
                    if (sameMemberBlocks.length > 0) {
                        console.warn('같은 시간대에 같은 회원의 예약이 존재합니다. 제거 후 진행합니다.');
                        sameMemberBlocks.forEach(block => {
                            if (block.parentNode) {
                                block.parentNode.removeChild(block);
                            }
                        });
                    } else {
                        console.log('다른 회원의 예약이 있지만, 같은 회원이 아니므로 그대로 진행합니다.');
                    }
                }
                
                // 추가 안전장치: 같은 슬롯에 있는 같은 회원의 블록만 제거
                const allBlocksInSlot = finalSlot.querySelectorAll('.reservation-block');
                const sameMemberBlocksInSlot = Array.from(allBlocksInSlot).filter(block => 
                    block.getAttribute('data-member-id') === memberId
                );
                
                sameMemberBlocksInSlot.forEach(block => {
                    if (block.parentNode) {
                        block.parentNode.removeChild(block);
                    }
                });
                
                // 슬롯 스타일 강제 설정
                finalSlot.style.position = 'relative';
                finalSlot.style.overflow = 'visible';
                finalSlot.style.zIndex = '1';
                finalSlot.style.minHeight = '60px'; // 최소 높이 보장
                
                // 예약 블록에 클릭 이벤트 추가
                block.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // 블록이 있는 슬롯에서 targetDay 정보 가져오기
                    const slotTargetDay = finalSlot.getAttribute('data-day');
                    // data-day는 1(월요일)~7(일요일), targetDay는 0(월요일)~6(일요일)
                    const actualTargetDay = slotTargetDay ? parseInt(slotTargetDay) - 1 : targetDay;
                    
                    console.log('예약 블록 클릭됨:', {
                        memberName, memberType, scheduleType,
                        startHour, startMinute, endHour, endMinute,
                        targetDay, actualTargetDay, targetSeat,
                        slotTargetDay: slotTargetDay
                    });
                    
                    // 기존 예약 정보로 모달 열기 (수정 모드)
                    const memberId = block.getAttribute('data-member-id');
                    const reservationId = block.getAttribute('data-reservation-id');
                    const reservationMemo = block.getAttribute('data-reservation-memo') || '';
                    const educationMemosStr = block.getAttribute('data-education-memos');
                    const functionTestDate = block.getAttribute('data-function-test-date') || '';
                    const roadTestDate = block.getAttribute('data-road-test-date') || '';
                    const contactPhone = block.getAttribute('data-contact-phone') || '';
                    const actualDate = block.getAttribute('data-actual-date') || '';
                    let educationMemos = [];
                    
                    console.log('블록에서 가져온 실제 날짜:', actualDate);
                    
                    if (educationMemosStr) {
                        try {
                            educationMemos = JSON.parse(educationMemosStr);
                        } catch (e) {
                            console.error('교육 메모 파싱 오류:', e);
                        }
                    }
                    
                    openReservationEditModal({
                        memberName, memberId, memberType, scheduleType,
                        startHour, startMinute, endHour, endMinute,
                        targetDay: actualTargetDay, targetSeat, reservationMemo, educationMemos,
                        functionTestDate, roadTestDate, reservationId,
                        contactPhone, productName, productHours, actualDate, blockElement: block
                    });
                });
                
                // 블록을 추가하기 전에 한 번 더 확인
                const duplicateBlocks = finalSlot.querySelectorAll('.reservation-block');
                duplicateBlocks.forEach(dupBlock => {
                    if (dupBlock.parentNode) {
                        dupBlock.parentNode.removeChild(dupBlock);
                    }
                });
                
                finalSlot.appendChild(block);
                
                // 블록 위치 강제 재계산
                setTimeout(() => {
                    block.style.position = 'absolute';
                    block.style.left = '2px';
                    block.style.right = '2px';
                    block.style.top = '0px';
                    block.style.width = 'calc(100% - 4px)';
                }, 10);
                
                console.log('예약 블록 추가됨:', {
                    targetSlot: targetSlot,
                    block: block,
                    position: targetSlot.getBoundingClientRect(),
                    day: targetDay,
                    seat: targetSeat,
                    timeIndex: startTimeIndex
                });
            } else {
                console.error('대상 슬롯을 찾을 수 없습니다:', {
                    startTimeIndex, targetDay, targetSeat,
                    selector: `[data-time-index="${startTimeIndex}"][data-day="${targetDay}"][data-seat="${targetSeat}"]`
                });
            }
        }
        
        // 시간을 인덱스로 변환하는 함수
        function getTimeIndex(hour, minute) {
            // 시간과 분을 정수로 변환
            const h = parseInt(hour);
            const m = parseInt(minute);
            
            // timeSlots 배열 형식에 맞게 시간 문자열 생성
            let timeString;
            if (h < 10) {
                timeString = `${h}:${m.toString().padStart(2, '0')}`;
            } else {
                timeString = `${h}:${m.toString().padStart(2, '0')}`;
            }
            
            console.log('시간 변환 시도:', timeString);
            console.log('timeSlots 배열:', timeSlots);
            
            const index = timeSlots.indexOf(timeString);
            console.log('찾은 인덱스:', index);
            
            return index;
        }
        
        
        
        // 시간 표시기 생성
        function createTimeIndicator() {
            // 기존 시간 표시기 제거
            const existing = document.getElementById('timeIndicator');
            if (existing) {
                existing.remove();
            }
            
            const indicator = document.createElement('div');
            indicator.id = 'timeIndicator';
            indicator.className = 'time-indicator';
            indicator.textContent = '시간 선택 중...';
            document.body.appendChild(indicator);
        }
        
        // 시간 표시기 업데이트
        function updateTimeIndicator() {
            const indicator = document.getElementById('timeIndicator');
            if (indicator && dragState.startTime !== null && dragState.endTime !== null) {
                const startTime = timeSlots[dragState.startTime];
                const endTime = timeSlots[dragState.endTime];
                indicator.textContent = `${startTime} - ${endTime}`;
            }
        }
        
        // 임시 예약 블록 업데이트 (특정 좌석에만)
        function updateTempReservation(startTime, endTime) {
            // 기존 임시 블록 제거
            const existingTemp = document.querySelector('.reservation-temp');
            if (existingTemp) {
                existingTemp.remove();
            }
            
            if (!dragState.startSlot || endTime <= startTime) return;
            
            // 시작 슬롯의 좌석 정보 가져오기
            const startDay = parseInt(dragState.startSlot.getAttribute('data-day'));
            const startSeat = parseInt(dragState.startSlot.getAttribute('data-seat'));
            
            // 해당 좌석의 세로 열 찾기
            const seatColumn = findSeatColumn(dragState.startSlot);
            if (seatColumn.length === 0) return;
            
            // 시작 시간에 해당하는 슬롯 찾기
            const startSlot = seatColumn.find(slot => 
                parseInt(slot.getAttribute('data-time-index')) === startTime
            );
            
            if (!startSlot) return;
            
            const duration = endTime - startTime;
            const block = document.createElement('div');
            block.className = 'reservation-temp';
            block.style.position = 'absolute';
            block.style.left = '2px';
            block.style.right = '2px';
            block.style.top = '0px';
            block.style.height = (duration * 60) + 'px';
            
            // 선택된 색상 적용
            const selectedOption = document.querySelector('.color-option.selected');
            if (selectedOption) {
                const color = selectedOption.style.backgroundColor || getComputedStyle(selectedOption).backgroundColor;
                block.style.backgroundColor = color.replace('rgb', 'rgba').replace(')', ', 0.5)');
                block.style.border = `1px solid ${color}`;
            } else {
                // 기본 색상
                block.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
                block.style.border = '1px solid #3b82f6';
            }
            
            block.style.borderRadius = '4px';
            block.style.zIndex = '10';
            block.textContent = '새 예약';
            block.style.color = 'white';
            block.style.display = 'flex';
            block.style.alignItems = 'center';
            block.style.justifyContent = 'center';
            block.style.fontSize = '12px';
            block.style.fontWeight = 'bold';
            
            // 시작 슬롯에 직접 추가
            startSlot.style.position = 'relative';
            startSlot.appendChild(block);
        }
        
        
        
        // 드래그 정리
        function cleanupDrag() {
            // 시간 표시기 제거
            const timeIndicator = document.getElementById('timeIndicator');
            if (timeIndicator) {
                timeIndicator.remove();
            }
            
            // 임시 예약 블록 제거
            const tempReservations = document.querySelectorAll('.reservation-temp');
            tempReservations.forEach(temp => temp.remove());
        }
        
        // 서버에 예약 저장하는 함수
        function saveReservationToServer(reservationData) {
            console.log('서버에 예약 데이터 전송:', reservationData);
            
            return fetch('api/save_reservation_simple.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reservationData)
            })
            .then(response => {
                console.log('서버 응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text().then(text => {
                    console.log('서버 응답 텍스트:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON 파싱 오류:', e);
                        console.error('응답 텍스트:', text);
                        throw new Error('서버 응답이 유효한 JSON이 아닙니다: ' + text);
                    }
                });
            })
            .then(result => {
                console.log('서버 응답 데이터:', result);
                if (result.success) {
                    return result.reservationId;
                } else {
                    throw new Error(result.message || '예약 저장에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('예약 저장 중 오류 발생:', error);
                console.error('오류 상세:', error.message);
                console.error('오류 스택:', error.stack);
                throw error;
            });
        }
        
        // 서버에서 예약 목록 불러오는 함수
        function loadReservationsFromServer() {
            return fetch('api/get_reservations.php')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 현재 주의 날짜 범위에 맞는 예약만 필터링
                    const currentWeek = getCurrentWeek();
                    const weekStart = new Date(currentWeek[0]);
                    const weekEnd = new Date(currentWeek[6]);
                    weekStart.setHours(0, 0, 0, 0);
                    weekEnd.setHours(23, 59, 59, 999);
                    
                    console.log('현재 주 범위:', {
                        weekStart: weekStart.toISOString().split('T')[0],
                        weekEnd: weekEnd.toISOString().split('T')[0]
                    });
                    
                    const filteredReservations = result.reservations.filter(reservation => {
                        // reservation_date가 있으면 그것을 사용, 없으면 targetDay로 계산
                        if (reservation.reservationDate) {
                            const reservationDate = new Date(reservation.reservationDate);
                            reservationDate.setHours(0, 0, 0, 0);
                            const isInCurrentWeek = reservationDate >= weekStart && reservationDate <= weekEnd;
                            
                            console.log('예약 필터링 (reservation_date 사용):', {
                                reservationId: reservation.id,
                                reservationDate: reservation.reservationDate,
                                isInCurrentWeek: isInCurrentWeek
                            });
                            
                            return isInCurrentWeek;
                        } else {
                            // reservation_date가 없으면 기존 방식 사용
                            const targetDay = parseInt(reservation.targetDay);
                            if (isNaN(targetDay) || targetDay < 1 || targetDay > 7) {
                                return false;
                            }
                            
                            const reservationDate = new Date(currentWeek[targetDay - 1]);
                            reservationDate.setHours(0, 0, 0, 0);
                            const isInCurrentWeek = reservationDate >= weekStart && reservationDate <= weekEnd;
                            
                            console.log('예약 필터링 (targetDay 사용):', {
                                reservationId: reservation.id,
                                targetDay: targetDay,
                                reservationDate: reservationDate.toISOString().split('T')[0],
                                isInCurrentWeek: isInCurrentWeek
                            });
                            
                            return isInCurrentWeek;
                        }
                    });
                    
                    console.log('필터링된 예약 수:', filteredReservations.length);
                    return filteredReservations;
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                console.error('예약 데이터 로드 오류:', error);
                throw error;
            });
        }
        
        // 서버에서 예약 수정하는 함수
        function updateReservationOnServer(reservationId, reservationData) {
            return fetch('api/update_reservation.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update',
                    reservationId: reservationId,
                    ...reservationData
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.message);
                }
            });
        }
        
        // 서버에서 예약 삭제하는 함수
        function deleteReservationFromServer(reservationId) {
            console.log('🗑️ deleteReservationFromServer 호출됨:', reservationId);
            
            const requestData = {
                action: 'delete',
                reservationId: reservationId
            };
            
            console.log('📤 서버에 전송할 데이터:', requestData);
            
            return fetch('api/update_reservation.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('📥 서버 응답 상태:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('📥 서버 응답 데이터:', result);
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.message || '서버에서 삭제 실패');
                }
            })
            .catch(error => {
                console.error('❌ deleteReservationFromServer 오류:', error);
                throw error;
            });
        }
        
        // 페이지 로드 시 서버에서 예약 데이터 불러오기
        async function loadReservationsOnPageLoad() {
            try {
                const reservations = await loadReservationsFromServer();
                
                // 서버에서 불러온 예약들을 화면에 표시
                if (reservations && reservations.length > 0) {
                    // 각 예약에 대해 비동기적으로 처리
                    const processReservations = async () => {
                        for (let index = 0; index < reservations.length; index++) {
                            const reservation = reservations[index];
                            
                            // targetDay와 targetSeat이 없으면 기본값 설정 (하지만 서버에서 올바른 값이 와야 함)
                            let targetDay = reservation.targetDay || 1;
                            let targetSeat = reservation.targetSeat || 1;
                            
                            // targetDay가 유효한지 확인 (1-7 범위)
                            if (targetDay < 1 || targetDay > 7) {
                                console.warn('잘못된 targetDay 값:', targetDay, '기본값 1로 설정');
                                targetDay = 1;
                            }
                            
                            // targetSeat이 유효한지 확인 (1-6 범위)
                            if (targetSeat < 1 || targetSeat > 6) {
                                console.warn('잘못된 targetSeat 값:', targetSeat, '기본값 1로 설정');
                                targetSeat = 1;
                            }
                            
                            // 회원 ID가 있으면 서버에서 최신 product_hours 가져오기
                            let productHours = reservation.product_hours || reservation.productHours || 0;
                            console.log('초기 productHours:', productHours, '타입:', typeof productHours);
                            
                            if (reservation.memberId && reservation.memberType !== 'quick') {
                                try {
                                    const memberResponse = await fetch(`api/debug_member_detail.php?id=${reservation.memberId}`);
                                    const memberResult = await memberResponse.json();
                                    if (memberResult.success && memberResult.member) {
                                        productHours = memberResult.member.product_hours || 0;
                                        console.log(`회원 ${reservation.memberId}의 최신 product_hours:`, productHours);
                                    }
                                } catch (error) {
                                    console.error('회원 정보 가져오기 실패:', error);
                                }
                            }
                            
                            // productHours를 숫자로 변환
                            productHours = Number(productHours) || 0;
                            console.log('최종 productHours:', productHours, '타입:', typeof productHours);
                            
                            console.log('예약 블록 생성 시도:', {
                                memberName: reservation.memberName,
                                targetDay: targetDay,
                                targetSeat: targetSeat,
                                startHour: reservation.startHour,
                                endHour: reservation.endHour,
                                productHours: productHours
                            });
                        
                            createReservationBlock(
                                reservation.memberName,
                                reservation.memberId,
                                reservation.memberType,
                                reservation.scheduleType,
                                reservation.startHour,
                                reservation.startMinute,
                                reservation.endHour,
                                reservation.endMinute,
                                reservation.reservationMemo,
                                reservation.educationMemos,
                                reservation.functionTestDate,
                                reservation.roadTestDate,
                                reservation.id,
                                targetDay,
                                targetSeat,
                                reservation.productName || reservation.product_name || reservation.product || '',
                                productHours,
                                reservation.contactPhone || ''
                            );
                        }
                    };
                    
                    processReservations();
                } else {
                    console.log('서버에서 불러온 예약이 없습니다.');
                }
                
                // 모든 예약 블록의 색상 업데이트
                setTimeout(() => {
                    updateAllReservationBlockColors();
                }, 1000); // 1초 후에 색상 업데이트
            } catch (error) {
                console.error('예약 데이터 로드 실패:', error);
            }
        }
        
        // 페이지 로드 시 예약 데이터 불러오기는 위의 DOMContentLoaded에서 처리됨
    </script>
</body>
</html>