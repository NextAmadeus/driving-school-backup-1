<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매출 현황 - 시금까시</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sales-dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .sales-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .sales-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 10px 0;
        }
        
        .sales-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 5px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0;
        }
        
        .stat-change {
            font-size: 0.8rem;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .stat-change.positive {
            background: #dcfce7;
            color: #166534;
        }
        
        .stat-change.negative {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 20px 0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .recent-sales {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .recent-sales-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .recent-sales-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .sales-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .sales-table th,
        .sales-table td {
            padding: 12px 25px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sales-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .sales-table td {
            color: #6b7280;
        }
        
        .amount {
            font-weight: 600;
            color: #059669;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc2626;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main">
        <div class="topbar">
            <div class="topbar__title">매출 현황</div>
            <div class="topbar__meta">실시간 매출 데이터 분석</div>
            <div class="topbar__spacer"></div>
            <div class="user__avatar" onclick="location.href='index.html'">홈</div>
        </div>
        
        <div class="sales-dashboard">
            <!-- 매출 헤더 -->
            <div class="sales-header">
                <h1 class="sales-title">매출 현황</h1>
                <p class="sales-subtitle">고객 결제 데이터를 기반으로 한 실시간 매출 분석</p>
            </div>
            
            <!-- 매출 현황 그래프들 -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">총 매출 현황</h3>
                    <div class="chart-container">
                        <canvas id="totalRevenueChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">월별 매출 비교</h3>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">고객 수 추이</h3>
                    <div class="chart-container">
                        <canvas id="customersChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">상품별 매출 비율</h3>
                    <div class="chart-container">
                        <canvas id="productChart"></canvas>
                    </div>
                </div>
            </div>
            
            
            <!-- 최근 매출 내역 -->
            <div class="recent-sales">
                <div class="recent-sales-header">
                    <h3 class="recent-sales-title">최근 매출 내역</h3>
                </div>
                <div id="recentSalesContent">
                    <div class="loading">데이터를 불러오는 중...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let salesData = {};
        let totalRevenueChart = null;
        let monthlyComparisonChart = null;
        let customersChart = null;
        let productChart = null;

        // 페이지 로드 시 데이터 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            loadSalesData();
        });

        // 매출 데이터 로드
        async function loadSalesData() {
            try {
                const response = await fetch('api/get_sales_data.php');
                const data = await response.json();
                
                if (data.success) {
                    salesData = data.data;
                    updateDashboard();
                } else {
                    showError('데이터를 불러오는데 실패했습니다: ' + data.message);
                }
            } catch (error) {
                console.error('매출 데이터 로드 오류:', error);
                showError('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 대시보드 업데이트
        function updateDashboard() {
            updateCharts();
            updateRecentSales();
        }


        // 차트 업데이트
        function updateCharts() {
            updateTotalRevenueChart();
            updateMonthlyComparisonChart();
            updateCustomersChart();
            updateProductChart();
        }

        // 총 매출 현황 차트
        function updateTotalRevenueChart() {
            const ctx = document.getElementById('totalRevenueChart').getContext('2d');
            
            if (totalRevenueChart) {
                totalRevenueChart.destroy();
            }
            
            const data = salesData;
            const totalRevenue = data.totalRevenue || 0;
            const monthlyRevenue = data.monthlyRevenue || 0;
            const avgOrderValue = data.avgOrderValue || 0;
            
            totalRevenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['총 매출', '이번 달 매출', '평균 주문 금액'],
                    datasets: [{
                        label: '금액 (원)',
                        data: [totalRevenue, monthlyRevenue, avgOrderValue],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 월별 매출 비교 차트
        function updateMonthlyComparisonChart() {
            const ctx = document.getElementById('monthlyComparisonChart').getContext('2d');
            
            if (monthlyComparisonChart) {
                monthlyComparisonChart.destroy();
            }
            
            const data = salesData.monthlyData || [];
            
            monthlyComparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month),
                    datasets: [{
                        label: '매출 (원)',
                        data: data.map(item => item.revenue),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 고객 수 추이 차트
        function updateCustomersChart() {
            const ctx = document.getElementById('customersChart').getContext('2d');
            
            if (customersChart) {
                customersChart.destroy();
            }
            
            const data = salesData;
            const totalCustomers = data.totalCustomers || 0;
            const monthlyCustomers = Math.round(totalCustomers * 0.1); // 임시 계산
            const repeatCustomers = Math.round(totalCustomers * 0.15);
            
            customersChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['신규 고객', '이번 달 고객', '재구매 고객'],
                    datasets: [{
                        data: [totalCustomers - monthlyCustomers, monthlyCustomers, repeatCustomers],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 상품별 매출 차트
        function updateProductChart() {
            const ctx = document.getElementById('productChart').getContext('2d');
            
            if (productChart) {
                productChart.destroy();
            }
            
            const data = salesData.productData || [];
            
            productChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.product),
                    datasets: [{
                        data: data.map(item => item.revenue),
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6',
                            '#06b6d4'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 최근 매출 내역 업데이트
        function updateRecentSales() {
            const container = document.getElementById('recentSalesContent');
            const data = salesData.recentSales || [];
            
            if (data.length === 0) {
                container.innerHTML = '<div class="loading">최근 매출 내역이 없습니다.</div>';
                return;
            }
            
            const html = `
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>고객명</th>
                            <th>상품</th>
                            <th>금액</th>
                            <th>결제일</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(sale => `
                            <tr>
                                <td>${sale.customerName}</td>
                                <td>${sale.product}</td>
                                <td class="amount">${formatCurrency(sale.amount)}</td>
                                <td>${sale.paymentDate}</td>
                                <td>${sale.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        // 통화 포맷팅
        function formatCurrency(amount) {
            return '₩' + amount.toLocaleString();
        }

        // 에러 표시
        function showError(message) {
            document.getElementById('recentSalesContent').innerHTML = 
                `<div class="error">${message}</div>`;
        }

        // 5분마다 데이터 새로고침
        setInterval(loadSalesData, 5 * 60 * 1000);
    </script>
</body>
</html>
